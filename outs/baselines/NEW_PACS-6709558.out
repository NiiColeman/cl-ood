
--- Run 1/3 ---

Running LoRA with TIES experiment
Test domain: art_painting
Train domains: ['sketch', 'cartoon', 'photo']
Baseline Model - Test Loss: 2.2401, Test Accuracy: 16.35%

Training LoRA adapter for domain: sketch

Training LoRA adapter for domain: sketch
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Epoch 1/10, Train Loss: 1.7848, Train Accuracy: 29.23%
Val Loss: 1.5625, Val Accuracy: 42.65%
Epoch 2/10, Train Loss: 1.3626, Train Accuracy: 52.94%
Val Loss: 1.2187, Val Accuracy: 58.82%
Epoch 3/10, Train Loss: 1.0633, Train Accuracy: 63.79%
Val Loss: 0.9580, Val Accuracy: 69.12%
Epoch 4/10, Train Loss: 0.7935, Train Accuracy: 72.98%
Val Loss: 0.7750, Val Accuracy: 68.38%
Epoch 5/10, Train Loss: 0.6476, Train Accuracy: 77.76%
Val Loss: 0.6412, Val Accuracy: 77.21%
Epoch 6/10, Train Loss: 0.5281, Train Accuracy: 81.07%
Val Loss: 0.5756, Val Accuracy: 77.21%
Epoch 7/10, Train Loss: 0.4252, Train Accuracy: 84.56%
Val Loss: 0.5541, Val Accuracy: 75.00%
Epoch 8/10, Train Loss: 0.3266, Train Accuracy: 88.97%
Val Loss: 0.4995, Val Accuracy: 80.15%
Epoch 9/10, Train Loss: 0.2751, Train Accuracy: 91.54%
Val Loss: 0.4909, Val Accuracy: 80.15%
Epoch 10/10, Train Loss: 0.2398, Train Accuracy: 93.38%
Val Loss: 0.4974, Val Accuracy: 79.41%
Best validation accuracy for sketch: 80.15%
LoRA state keys: dict_keys(['base_model.model.blocks.0.attn.qkv.lora_A.weight', 'base_model.model.blocks.0.attn.qkv.lora_B.weight', 'base_model.model.blocks.1.attn.qkv.lora_A.weight', 'base_model.model.blocks.1.attn.qkv.lora_B.weight', 'base_model.model.blocks.2.attn.qkv.lora_A.weight', 'base_model.model.blocks.2.attn.qkv.lora_B.weight', 'base_model.model.blocks.3.attn.qkv.lora_A.weight', 'base_model.model.blocks.3.attn.qkv.lora_B.weight', 'base_model.model.blocks.4.attn.qkv.lora_A.weight', 'base_model.model.blocks.4.attn.qkv.lora_B.weight', 'base_model.model.blocks.5.attn.qkv.lora_A.weight', 'base_model.model.blocks.5.attn.qkv.lora_B.weight', 'base_model.model.blocks.6.attn.qkv.lora_A.weight', 'base_model.model.blocks.6.attn.qkv.lora_B.weight', 'base_model.model.blocks.7.attn.qkv.lora_A.weight', 'base_model.model.blocks.7.attn.qkv.lora_B.weight', 'base_model.model.blocks.8.attn.qkv.lora_A.weight', 'base_model.model.blocks.8.attn.qkv.lora_B.weight', 'base_model.model.blocks.9.attn.qkv.lora_A.weight', 'base_model.model.blocks.9.attn.qkv.lora_B.weight', 'base_model.model.blocks.10.attn.qkv.lora_A.weight', 'base_model.model.blocks.10.attn.qkv.lora_B.weight', 'base_model.model.blocks.11.attn.qkv.lora_A.weight', 'base_model.model.blocks.11.attn.qkv.lora_B.weight'])
sketch adapter trained. Validation Accuracy: 80.15%

Training LoRA adapter for domain: cartoon

Training LoRA adapter for domain: cartoon
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Epoch 1/10, Train Loss: 2.1059, Train Accuracy: 15.18%
Val Loss: 2.0675, Val Accuracy: 12.14%
Epoch 2/10, Train Loss: 1.7427, Train Accuracy: 29.11%
Val Loss: 1.7197, Val Accuracy: 31.43%
Epoch 3/10, Train Loss: 1.3064, Train Accuracy: 55.00%
Val Loss: 1.2793, Val Accuracy: 57.14%
Epoch 4/10, Train Loss: 0.8250, Train Accuracy: 76.25%
Val Loss: 0.9118, Val Accuracy: 70.71%
Epoch 5/10, Train Loss: 0.4477, Train Accuracy: 87.68%
Val Loss: 0.6555, Val Accuracy: 76.43%
Epoch 6/10, Train Loss: 0.2530, Train Accuracy: 93.93%
Val Loss: 0.5279, Val Accuracy: 81.43%
Epoch 7/10, Train Loss: 0.1399, Train Accuracy: 97.32%
Val Loss: 0.4168, Val Accuracy: 83.57%
Epoch 8/10, Train Loss: 0.0917, Train Accuracy: 98.57%
Val Loss: 0.3740, Val Accuracy: 85.71%
Epoch 9/10, Train Loss: 0.0618, Train Accuracy: 99.82%
Val Loss: 0.3609, Val Accuracy: 85.71%
Epoch 10/10, Train Loss: 0.0369, Train Accuracy: 100.00%
Val Loss: 0.3197, Val Accuracy: 87.86%
Best validation accuracy for cartoon: 87.86%
LoRA state keys: dict_keys(['base_model.model.blocks.0.attn.qkv.lora_A.weight', 'base_model.model.blocks.0.attn.qkv.lora_B.weight', 'base_model.model.blocks.1.attn.qkv.lora_A.weight', 'base_model.model.blocks.1.attn.qkv.lora_B.weight', 'base_model.model.blocks.2.attn.qkv.lora_A.weight', 'base_model.model.blocks.2.attn.qkv.lora_B.weight', 'base_model.model.blocks.3.attn.qkv.lora_A.weight', 'base_model.model.blocks.3.attn.qkv.lora_B.weight', 'base_model.model.blocks.4.attn.qkv.lora_A.weight', 'base_model.model.blocks.4.attn.qkv.lora_B.weight', 'base_model.model.blocks.5.attn.qkv.lora_A.weight', 'base_model.model.blocks.5.attn.qkv.lora_B.weight', 'base_model.model.blocks.6.attn.qkv.lora_A.weight', 'base_model.model.blocks.6.attn.qkv.lora_B.weight', 'base_model.model.blocks.7.attn.qkv.lora_A.weight', 'base_model.model.blocks.7.attn.qkv.lora_B.weight', 'base_model.model.blocks.8.attn.qkv.lora_A.weight', 'base_model.model.blocks.8.attn.qkv.lora_B.weight', 'base_model.model.blocks.9.attn.qkv.lora_A.weight', 'base_model.model.blocks.9.attn.qkv.lora_B.weight', 'base_model.model.blocks.10.attn.qkv.lora_A.weight', 'base_model.model.blocks.10.attn.qkv.lora_B.weight', 'base_model.model.blocks.11.attn.qkv.lora_A.weight', 'base_model.model.blocks.11.attn.qkv.lora_B.weight'])
cartoon adapter trained. Validation Accuracy: 87.86%

Training LoRA adapter for domain: photo

Training LoRA adapter for domain: photo
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Epoch 1/10, Train Loss: 2.0162, Train Accuracy: 18.04%
Val Loss: 1.7446, Val Accuracy: 33.57%
Epoch 2/10, Train Loss: 1.4804, Train Accuracy: 48.57%
Val Loss: 1.2308, Val Accuracy: 70.71%
Epoch 3/10, Train Loss: 0.8827, Train Accuracy: 85.54%
Val Loss: 0.6444, Val Accuracy: 90.71%
Epoch 4/10, Train Loss: 0.3680, Train Accuracy: 96.61%
Val Loss: 0.2490, Val Accuracy: 94.29%
Epoch 5/10, Train Loss: 0.1124, Train Accuracy: 98.93%
Val Loss: 0.1282, Val Accuracy: 97.14%
Epoch 6/10, Train Loss: 0.0360, Train Accuracy: 99.82%
Val Loss: 0.0931, Val Accuracy: 97.14%
Epoch 7/10, Train Loss: 0.0161, Train Accuracy: 100.00%
Val Loss: 0.0826, Val Accuracy: 97.86%
Epoch 8/10, Train Loss: 0.0092, Train Accuracy: 100.00%
Val Loss: 0.0757, Val Accuracy: 96.43%
Epoch 9/10, Train Loss: 0.0063, Train Accuracy: 100.00%
Val Loss: 0.0741, Val Accuracy: 97.86%
Epoch 10/10, Train Loss: 0.0046, Train Accuracy: 100.00%
Val Loss: 0.0704, Val Accuracy: 97.14%
Best validation accuracy for photo: 97.86%
LoRA state keys: dict_keys(['base_model.model.blocks.0.attn.qkv.lora_A.weight', 'base_model.model.blocks.0.attn.qkv.lora_B.weight', 'base_model.model.blocks.1.attn.qkv.lora_A.weight', 'base_model.model.blocks.1.attn.qkv.lora_B.weight', 'base_model.model.blocks.2.attn.qkv.lora_A.weight', 'base_model.model.blocks.2.attn.qkv.lora_B.weight', 'base_model.model.blocks.3.attn.qkv.lora_A.weight', 'base_model.model.blocks.3.attn.qkv.lora_B.weight', 'base_model.model.blocks.4.attn.qkv.lora_A.weight', 'base_model.model.blocks.4.attn.qkv.lora_B.weight', 'base_model.model.blocks.5.attn.qkv.lora_A.weight', 'base_model.model.blocks.5.attn.qkv.lora_B.weight', 'base_model.model.blocks.6.attn.qkv.lora_A.weight', 'base_model.model.blocks.6.attn.qkv.lora_B.weight', 'base_model.model.blocks.7.attn.qkv.lora_A.weight', 'base_model.model.blocks.7.attn.qkv.lora_B.weight', 'base_model.model.blocks.8.attn.qkv.lora_A.weight', 'base_model.model.blocks.8.attn.qkv.lora_B.weight', 'base_model.model.blocks.9.attn.qkv.lora_A.weight', 'base_model.model.blocks.9.attn.qkv.lora_B.weight', 'base_model.model.blocks.10.attn.qkv.lora_A.weight', 'base_model.model.blocks.10.attn.qkv.lora_B.weight', 'base_model.model.blocks.11.attn.qkv.lora_A.weight', 'base_model.model.blocks.11.attn.qkv.lora_B.weight'])
photo adapter trained. Validation Accuracy: 97.86%

Evaluating individual LoRA adapters on the test domain:
Created LoRA model: <class 'peft.peft_model.PeftModel'>
sketch adapter - Test Loss: 2.0544, Test Accuracy: 24.29%
Created LoRA model: <class 'peft.peft_model.PeftModel'>
cartoon adapter - Test Loss: 1.1851, Test Accuracy: 61.75%
Created LoRA model: <class 'peft.peft_model.PeftModel'>
photo adapter - Test Loss: 1.1795, Test Accuracy: 65.87%

Training coefficients for adapter merging
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Epoch 1, Loss: 1.1254, Accuracy: 67.14%
Coefficients: [0.30694374 0.32747006 0.36558625]
Gradients: tensor([-1.3033e-08, -2.7569e-09, -8.6112e-09], device='cuda:0')
Epoch 2, Loss: 1.0732, Accuracy: 67.14%
Coefficients: [0.30689394 0.32599005 0.367116  ]
Gradients: tensor([-1.2158e-09,  6.3730e-10,  5.7854e-10], device='cuda:0')
Epoch 3, Loss: 1.0493, Accuracy: 67.14%
Coefficients: [0.30697122 0.32451826 0.36851057]
Gradients: tensor([-1.2919e-08, -1.1270e-08, -3.7466e-09], device='cuda:0')
Epoch 4, Loss: 1.2875, Accuracy: 67.14%
Coefficients: [0.30762705 0.3243674  0.3680055 ]
Gradients: tensor([-8.1425e-09,  3.7114e-09,  7.7488e-09], device='cuda:0')
Epoch 5, Loss: 0.8184, Accuracy: 67.14%
Coefficients: [0.30819246 0.3247365  0.367071  ]
Gradients: tensor([3.3224e-09, 3.5520e-09, 4.3015e-09], device='cuda:0')
Epoch 6, Loss: 0.9834, Accuracy: 67.14%
Coefficients: [0.3085298  0.32528868 0.36618152]
Gradients: tensor([6.1602e-09, 7.9256e-09, 1.0698e-08], device='cuda:0')
Epoch 7, Loss: 1.0889, Accuracy: 67.14%
Coefficients: [0.30878288 0.32529718 0.36591995]
Gradients: tensor([4.6811e-09, 1.5375e-08, 9.0926e-09], device='cuda:0')
Epoch 8, Loss: 1.0013, Accuracy: 67.14%
Coefficients: [0.30929625 0.32450947 0.36619425]
Gradients: tensor([9.5882e-11, 1.5801e-10, 2.1177e-10], device='cuda:0')
Epoch 9, Loss: 0.9335, Accuracy: 67.14%
Coefficients: [0.30993405 0.32377318 0.36629277]
Gradients: tensor([-5.0796e-09, -3.5508e-09, -4.0458e-09], device='cuda:0')
Epoch 10, Loss: 0.9722, Accuracy: 67.14%
Coefficients: [0.31044346 0.3229529  0.36660364]
Gradients: tensor([1.7328e-09, 1.3401e-09, 3.3437e-09], device='cuda:0')
Best coefficient accuracy: 67.14%
Final best coefficients: [0.30694374 0.32747006 0.36558625]

Merged model with TIES - Test Loss: 1.1795, Test Accuracy: 65.87%

Debugging merged model predictions:
Batch 1:
  Labels: [5 3 3 2 4 3 5 3 4 0 6 2 2 6 6 6 1 4 1 2 1 3 5 4 4 6 0 2 4 0 1 0]
  Predictions: [5 3 3 2 0 3 5 3 4 0 0 2 2 0 0 0 1 2 0 0 1 3 5 0 4 6 0 2 4 0 0 0]
  Accuracy: 68.75%
Batch 2:
  Labels: [2 3 0 2 4 5 6 5 6 6 6 1 0 6 0 0 2 5 1 3 5 4 6 4 4 0 6 4 6 2 1 2]
  Predictions: [2 3 0 0 4 5 0 0 0 0 0 1 0 0 0 0 3 5 3 3 5 0 0 4 4 0 2 4 3 0 0 0]
  Accuracy: 50.00%
Batch 3:
  Labels: [3 1 1 3 1 6 3 6 2 3 6 6 2 5 4 3 1 2 2 6 4 2 4 3 1 4 4 6 1 0 0 2]
  Predictions: [3 1 1 3 1 0 3 0 2 3 0 0 2 5 4 3 1 0 2 6 0 2 4 3 0 4 0 0 1 0 0 0]
  Accuracy: 68.75%
Batch 4:
  Labels: [6 1 1 4 0 4 5 0 5 3 0 0 1 3 6 6 1 1 1 2 6 1 4 0 4 3 4 1 6 4 0 5]
  Predictions: [0 1 0 0 2 0 5 0 5 3 0 4 1 3 1 6 1 0 1 2 0 0 4 3 4 0 4 1 0 0 0 3]
  Accuracy: 53.12%
Batch 5:
  Labels: [1 1 5 0 6 1 6 5 0 3 2 6 3 2 6 6 5 0 5 5 4 4 2 1 4 5 2 6 1 5 3 2]
  Predictions: [0 0 5 0 6 3 0 5 0 3 2 0 3 0 0 3 5 0 5 5 0 4 2 1 4 5 2 0 4 5 3 3]
  Accuracy: 62.50%

--- Run 2/3 ---

Running LoRA with TIES experiment
Test domain: art_painting
Train domains: ['sketch', 'cartoon', 'photo']
Baseline Model - Test Loss: 2.2401, Test Accuracy: 16.35%

Training LoRA adapter for domain: sketch

Training LoRA adapter for domain: sketch
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Epoch 1/10, Train Loss: 1.7848, Train Accuracy: 29.23%
Val Loss: 1.5625, Val Accuracy: 42.65%
Epoch 2/10, Train Loss: 1.3626, Train Accuracy: 52.94%
Val Loss: 1.2187, Val Accuracy: 58.82%
Epoch 3/10, Train Loss: 1.0633, Train Accuracy: 63.79%
Val Loss: 0.9580, Val Accuracy: 69.12%
Epoch 4/10, Train Loss: 0.7935, Train Accuracy: 72.98%
Val Loss: 0.7750, Val Accuracy: 68.38%
Epoch 5/10, Train Loss: 0.6476, Train Accuracy: 77.76%
Val Loss: 0.6412, Val Accuracy: 77.21%
Epoch 6/10, Train Loss: 0.5281, Train Accuracy: 81.07%
Val Loss: 0.5756, Val Accuracy: 77.21%
Epoch 7/10, Train Loss: 0.4252, Train Accuracy: 84.56%
Val Loss: 0.5541, Val Accuracy: 75.00%
Epoch 8/10, Train Loss: 0.3266, Train Accuracy: 88.97%
Val Loss: 0.4995, Val Accuracy: 80.15%
Epoch 9/10, Train Loss: 0.2751, Train Accuracy: 91.54%
Val Loss: 0.4909, Val Accuracy: 80.15%
Epoch 10/10, Train Loss: 0.2398, Train Accuracy: 93.38%
Val Loss: 0.4974, Val Accuracy: 79.41%
Best validation accuracy for sketch: 80.15%
LoRA state keys: dict_keys(['base_model.model.blocks.0.attn.qkv.lora_A.weight', 'base_model.model.blocks.0.attn.qkv.lora_B.weight', 'base_model.model.blocks.1.attn.qkv.lora_A.weight', 'base_model.model.blocks.1.attn.qkv.lora_B.weight', 'base_model.model.blocks.2.attn.qkv.lora_A.weight', 'base_model.model.blocks.2.attn.qkv.lora_B.weight', 'base_model.model.blocks.3.attn.qkv.lora_A.weight', 'base_model.model.blocks.3.attn.qkv.lora_B.weight', 'base_model.model.blocks.4.attn.qkv.lora_A.weight', 'base_model.model.blocks.4.attn.qkv.lora_B.weight', 'base_model.model.blocks.5.attn.qkv.lora_A.weight', 'base_model.model.blocks.5.attn.qkv.lora_B.weight', 'base_model.model.blocks.6.attn.qkv.lora_A.weight', 'base_model.model.blocks.6.attn.qkv.lora_B.weight', 'base_model.model.blocks.7.attn.qkv.lora_A.weight', 'base_model.model.blocks.7.attn.qkv.lora_B.weight', 'base_model.model.blocks.8.attn.qkv.lora_A.weight', 'base_model.model.blocks.8.attn.qkv.lora_B.weight', 'base_model.model.blocks.9.attn.qkv.lora_A.weight', 'base_model.model.blocks.9.attn.qkv.lora_B.weight', 'base_model.model.blocks.10.attn.qkv.lora_A.weight', 'base_model.model.blocks.10.attn.qkv.lora_B.weight', 'base_model.model.blocks.11.attn.qkv.lora_A.weight', 'base_model.model.blocks.11.attn.qkv.lora_B.weight'])
sketch adapter trained. Validation Accuracy: 80.15%

Training LoRA adapter for domain: cartoon

Training LoRA adapter for domain: cartoon
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Epoch 1/10, Train Loss: 2.1059, Train Accuracy: 15.18%
Val Loss: 2.0675, Val Accuracy: 12.14%
Epoch 2/10, Train Loss: 1.7427, Train Accuracy: 29.11%
Val Loss: 1.7197, Val Accuracy: 31.43%
Epoch 3/10, Train Loss: 1.3064, Train Accuracy: 55.00%
Val Loss: 1.2793, Val Accuracy: 57.14%
Epoch 4/10, Train Loss: 0.8250, Train Accuracy: 76.25%
Val Loss: 0.9117, Val Accuracy: 70.71%
Epoch 5/10, Train Loss: 0.4478, Train Accuracy: 87.68%
Val Loss: 0.6555, Val Accuracy: 76.43%
Epoch 6/10, Train Loss: 0.2530, Train Accuracy: 93.93%
Val Loss: 0.5286, Val Accuracy: 81.43%
Epoch 7/10, Train Loss: 0.1398, Train Accuracy: 97.32%
Val Loss: 0.4153, Val Accuracy: 82.14%
Epoch 8/10, Train Loss: 0.0916, Train Accuracy: 98.57%
Val Loss: 0.3748, Val Accuracy: 85.71%
Epoch 9/10, Train Loss: 0.0622, Train Accuracy: 99.82%
Val Loss: 0.3622, Val Accuracy: 85.71%
Epoch 10/10, Train Loss: 0.0368, Train Accuracy: 100.00%
Val Loss: 0.3231, Val Accuracy: 87.86%
Best validation accuracy for cartoon: 87.86%
LoRA state keys: dict_keys(['base_model.model.blocks.0.attn.qkv.lora_A.weight', 'base_model.model.blocks.0.attn.qkv.lora_B.weight', 'base_model.model.blocks.1.attn.qkv.lora_A.weight', 'base_model.model.blocks.1.attn.qkv.lora_B.weight', 'base_model.model.blocks.2.attn.qkv.lora_A.weight', 'base_model.model.blocks.2.attn.qkv.lora_B.weight', 'base_model.model.blocks.3.attn.qkv.lora_A.weight', 'base_model.model.blocks.3.attn.qkv.lora_B.weight', 'base_model.model.blocks.4.attn.qkv.lora_A.weight', 'base_model.model.blocks.4.attn.qkv.lora_B.weight', 'base_model.model.blocks.5.attn.qkv.lora_A.weight', 'base_model.model.blocks.5.attn.qkv.lora_B.weight', 'base_model.model.blocks.6.attn.qkv.lora_A.weight', 'base_model.model.blocks.6.attn.qkv.lora_B.weight', 'base_model.model.blocks.7.attn.qkv.lora_A.weight', 'base_model.model.blocks.7.attn.qkv.lora_B.weight', 'base_model.model.blocks.8.attn.qkv.lora_A.weight', 'base_model.model.blocks.8.attn.qkv.lora_B.weight', 'base_model.model.blocks.9.attn.qkv.lora_A.weight', 'base_model.model.blocks.9.attn.qkv.lora_B.weight', 'base_model.model.blocks.10.attn.qkv.lora_A.weight', 'base_model.model.blocks.10.attn.qkv.lora_B.weight', 'base_model.model.blocks.11.attn.qkv.lora_A.weight', 'base_model.model.blocks.11.attn.qkv.lora_B.weight'])
cartoon adapter trained. Validation Accuracy: 87.86%

Training LoRA adapter for domain: photo

Training LoRA adapter for domain: photo
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Epoch 1/10, Train Loss: 2.0162, Train Accuracy: 18.04%
Val Loss: 1.7446, Val Accuracy: 33.57%
Epoch 2/10, Train Loss: 1.4805, Train Accuracy: 48.57%
Val Loss: 1.2309, Val Accuracy: 70.71%
Epoch 3/10, Train Loss: 0.8813, Train Accuracy: 85.89%
Val Loss: 0.6440, Val Accuracy: 90.71%
Epoch 4/10, Train Loss: 0.3646, Train Accuracy: 96.61%
Val Loss: 0.2487, Val Accuracy: 94.29%
Epoch 5/10, Train Loss: 0.1118, Train Accuracy: 98.93%
Val Loss: 0.1350, Val Accuracy: 96.43%
Epoch 6/10, Train Loss: 0.0371, Train Accuracy: 99.82%
Val Loss: 0.1013, Val Accuracy: 96.43%
Epoch 7/10, Train Loss: 0.0167, Train Accuracy: 100.00%
Val Loss: 0.0844, Val Accuracy: 97.86%
Epoch 8/10, Train Loss: 0.0094, Train Accuracy: 100.00%
Val Loss: 0.0800, Val Accuracy: 95.71%
Epoch 9/10, Train Loss: 0.0063, Train Accuracy: 100.00%
Val Loss: 0.0771, Val Accuracy: 97.14%
Epoch 10/10, Train Loss: 0.0047, Train Accuracy: 100.00%
Val Loss: 0.0753, Val Accuracy: 97.14%
Best validation accuracy for photo: 97.86%
LoRA state keys: dict_keys(['base_model.model.blocks.0.attn.qkv.lora_A.weight', 'base_model.model.blocks.0.attn.qkv.lora_B.weight', 'base_model.model.blocks.1.attn.qkv.lora_A.weight', 'base_model.model.blocks.1.attn.qkv.lora_B.weight', 'base_model.model.blocks.2.attn.qkv.lora_A.weight', 'base_model.model.blocks.2.attn.qkv.lora_B.weight', 'base_model.model.blocks.3.attn.qkv.lora_A.weight', 'base_model.model.blocks.3.attn.qkv.lora_B.weight', 'base_model.model.blocks.4.attn.qkv.lora_A.weight', 'base_model.model.blocks.4.attn.qkv.lora_B.weight', 'base_model.model.blocks.5.attn.qkv.lora_A.weight', 'base_model.model.blocks.5.attn.qkv.lora_B.weight', 'base_model.model.blocks.6.attn.qkv.lora_A.weight', 'base_model.model.blocks.6.attn.qkv.lora_B.weight', 'base_model.model.blocks.7.attn.qkv.lora_A.weight', 'base_model.model.blocks.7.attn.qkv.lora_B.weight', 'base_model.model.blocks.8.attn.qkv.lora_A.weight', 'base_model.model.blocks.8.attn.qkv.lora_B.weight', 'base_model.model.blocks.9.attn.qkv.lora_A.weight', 'base_model.model.blocks.9.attn.qkv.lora_B.weight', 'base_model.model.blocks.10.attn.qkv.lora_A.weight', 'base_model.model.blocks.10.attn.qkv.lora_B.weight', 'base_model.model.blocks.11.attn.qkv.lora_A.weight', 'base_model.model.blocks.11.attn.qkv.lora_B.weight'])
photo adapter trained. Validation Accuracy: 97.86%

Evaluating individual LoRA adapters on the test domain:
Created LoRA model: <class 'peft.peft_model.PeftModel'>
sketch adapter - Test Loss: 2.0543, Test Accuracy: 24.29%
Created LoRA model: <class 'peft.peft_model.PeftModel'>
cartoon adapter - Test Loss: 1.1863, Test Accuracy: 61.90%
Created LoRA model: <class 'peft.peft_model.PeftModel'>
photo adapter - Test Loss: 1.1769, Test Accuracy: 65.40%

Training coefficients for adapter merging
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Epoch 1, Loss: 1.0964, Accuracy: 68.57%
Coefficients: [0.304223   0.32921222 0.36656478]
Gradients: tensor([ 2.3618e-09, -2.2474e-09, -4.5741e-09], device='cuda:0')
Epoch 2, Loss: 1.0601, Accuracy: 68.57%
Coefficients: [0.30285624 0.3299035  0.36724028]
Gradients: tensor([ 1.6220e-09, -6.6960e-09,  4.8184e-09], device='cuda:0')
Epoch 3, Loss: 1.0391, Accuracy: 68.57%
Coefficients: [0.30201218 0.33131918 0.36666864]
Gradients: tensor([9.4615e-09, 6.6436e-09, 1.3697e-08], device='cuda:0')
Epoch 4, Loss: 1.2578, Accuracy: 68.57%
Coefficients: [0.30191487 0.3323385  0.3657466 ]
Gradients: tensor([ 4.7970e-09,  1.1360e-08, -1.3962e-08], device='cuda:0')
Epoch 5, Loss: 0.8008, Accuracy: 68.57%
Coefficients: [0.30189016 0.33306345 0.36504638]
Gradients: tensor([-1.6295e-11,  1.7467e-11, -8.1046e-11], device='cuda:0')
Epoch 6, Loss: 0.9646, Accuracy: 68.57%
Coefficients: [0.30193692 0.3336589  0.3644042 ]
Gradients: tensor([-6.7708e-09, -1.2965e-08, -1.0903e-08], device='cuda:0')
Epoch 7, Loss: 1.0643, Accuracy: 68.57%
Coefficients: [0.3020594 0.33372   0.3642206]
Gradients: tensor([1.1455e-08, 2.5939e-09, 1.3261e-08], device='cuda:0')
Epoch 8, Loss: 0.9826, Accuracy: 68.57%
Coefficients: [0.3020602  0.33450085 0.36343893]
Gradients: tensor([-1.6575e-11,  9.3987e-12, -2.3359e-11], device='cuda:0')
Epoch 9, Loss: 0.9308, Accuracy: 68.57%
Coefficients: [0.3024597  0.33494598 0.3625944 ]
Gradients: tensor([ 1.1879e-09, -1.0214e-09,  1.5916e-09], device='cuda:0')
Epoch 10, Loss: 0.9498, Accuracy: 68.57%
Coefficients: [0.30295992 0.33461866 0.36242136]
Gradients: tensor([-1.2051e-09,  5.2134e-10,  1.3419e-09], device='cuda:0')
Best coefficient accuracy: 68.57%
Final best coefficients: [0.304223   0.32921222 0.36656478]

Merged model with TIES - Test Loss: 1.1769, Test Accuracy: 65.40%

Debugging merged model predictions:
Batch 1:
  Labels: [5 3 3 2 4 3 5 3 4 0 6 2 2 6 6 6 1 4 1 2 1 3 5 4 4 6 0 2 4 0 1 0]
  Predictions: [5 3 3 2 0 3 5 3 4 0 0 2 2 0 0 0 1 2 0 0 1 3 5 0 4 6 0 2 4 0 0 0]
  Accuracy: 68.75%
Batch 2:
  Labels: [2 3 0 2 4 5 6 5 6 6 6 1 0 6 0 0 2 5 1 3 5 4 6 4 4 0 6 4 6 2 1 2]
  Predictions: [2 3 0 0 4 5 0 5 0 0 0 1 0 0 0 0 3 5 3 3 5 0 0 4 4 0 0 4 3 0 0 0]
  Accuracy: 53.12%
Batch 3:
  Labels: [3 1 1 3 1 6 3 6 2 3 6 6 2 5 4 3 1 2 2 6 4 2 4 3 1 4 4 6 1 0 0 2]
  Predictions: [3 1 1 3 1 0 3 0 2 3 0 0 2 5 4 3 1 0 2 6 0 2 4 3 0 4 4 0 0 0 0 0]
  Accuracy: 68.75%
Batch 4:
  Labels: [6 1 1 4 0 4 5 0 5 3 0 0 1 3 6 6 1 1 1 2 6 1 4 0 4 3 4 1 6 4 0 5]
  Predictions: [0 1 0 0 4 0 5 0 5 3 0 4 0 3 3 6 1 0 1 2 0 0 4 3 4 0 0 1 0 0 0 3]
  Accuracy: 46.88%
Batch 5:
  Labels: [1 1 5 0 6 1 6 5 0 3 2 6 3 2 6 6 5 0 5 5 4 4 2 1 4 5 2 6 1 5 3 2]
  Predictions: [0 0 5 0 6 3 0 5 0 3 2 0 3 0 0 3 5 0 5 5 0 4 2 1 4 5 2 0 4 5 3 3]
  Accuracy: 62.50%

--- Run 3/3 ---

Running LoRA with TIES experiment
Test domain: art_painting
Train domains: ['sketch', 'cartoon', 'photo']
Baseline Model - Test Loss: 2.2401, Test Accuracy: 16.35%

Training LoRA adapter for domain: sketch

Training LoRA adapter for domain: sketch
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Epoch 1/10, Train Loss: 1.7848, Train Accuracy: 29.23%
Val Loss: 1.5625, Val Accuracy: 42.65%
Epoch 2/10, Train Loss: 1.3626, Train Accuracy: 52.94%
Val Loss: 1.2187, Val Accuracy: 58.82%
Epoch 3/10, Train Loss: 1.0633, Train Accuracy: 63.79%
Val Loss: 0.9580, Val Accuracy: 69.12%
Epoch 4/10, Train Loss: 0.7935, Train Accuracy: 72.98%
Val Loss: 0.7750, Val Accuracy: 68.38%
Epoch 5/10, Train Loss: 0.6476, Train Accuracy: 77.76%
Val Loss: 0.6412, Val Accuracy: 77.21%
Epoch 6/10, Train Loss: 0.5281, Train Accuracy: 81.07%
Val Loss: 0.5756, Val Accuracy: 77.21%
Epoch 7/10, Train Loss: 0.4252, Train Accuracy: 84.56%
Val Loss: 0.5541, Val Accuracy: 75.00%
Epoch 8/10, Train Loss: 0.3266, Train Accuracy: 88.97%
Val Loss: 0.4995, Val Accuracy: 80.15%
Epoch 9/10, Train Loss: 0.2751, Train Accuracy: 91.54%
Val Loss: 0.4909, Val Accuracy: 80.15%
Epoch 10/10, Train Loss: 0.2398, Train Accuracy: 93.38%
Val Loss: 0.4974, Val Accuracy: 79.41%
Best validation accuracy for sketch: 80.15%
LoRA state keys: dict_keys(['base_model.model.blocks.0.attn.qkv.lora_A.weight', 'base_model.model.blocks.0.attn.qkv.lora_B.weight', 'base_model.model.blocks.1.attn.qkv.lora_A.weight', 'base_model.model.blocks.1.attn.qkv.lora_B.weight', 'base_model.model.blocks.2.attn.qkv.lora_A.weight', 'base_model.model.blocks.2.attn.qkv.lora_B.weight', 'base_model.model.blocks.3.attn.qkv.lora_A.weight', 'base_model.model.blocks.3.attn.qkv.lora_B.weight', 'base_model.model.blocks.4.attn.qkv.lora_A.weight', 'base_model.model.blocks.4.attn.qkv.lora_B.weight', 'base_model.model.blocks.5.attn.qkv.lora_A.weight', 'base_model.model.blocks.5.attn.qkv.lora_B.weight', 'base_model.model.blocks.6.attn.qkv.lora_A.weight', 'base_model.model.blocks.6.attn.qkv.lora_B.weight', 'base_model.model.blocks.7.attn.qkv.lora_A.weight', 'base_model.model.blocks.7.attn.qkv.lora_B.weight', 'base_model.model.blocks.8.attn.qkv.lora_A.weight', 'base_model.model.blocks.8.attn.qkv.lora_B.weight', 'base_model.model.blocks.9.attn.qkv.lora_A.weight', 'base_model.model.blocks.9.attn.qkv.lora_B.weight', 'base_model.model.blocks.10.attn.qkv.lora_A.weight', 'base_model.model.blocks.10.attn.qkv.lora_B.weight', 'base_model.model.blocks.11.attn.qkv.lora_A.weight', 'base_model.model.blocks.11.attn.qkv.lora_B.weight'])
sketch adapter trained. Validation Accuracy: 80.15%

Training LoRA adapter for domain: cartoon

Training LoRA adapter for domain: cartoon
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Epoch 1/10, Train Loss: 2.1059, Train Accuracy: 15.18%
Val Loss: 2.0675, Val Accuracy: 12.14%
Epoch 2/10, Train Loss: 1.7427, Train Accuracy: 29.11%
Val Loss: 1.7197, Val Accuracy: 31.43%
Epoch 3/10, Train Loss: 1.3063, Train Accuracy: 55.00%
Val Loss: 1.2793, Val Accuracy: 57.14%
Epoch 4/10, Train Loss: 0.8250, Train Accuracy: 76.25%
Val Loss: 0.9117, Val Accuracy: 70.71%
Epoch 5/10, Train Loss: 0.4478, Train Accuracy: 87.68%
Val Loss: 0.6555, Val Accuracy: 76.43%
Epoch 6/10, Train Loss: 0.2530, Train Accuracy: 93.93%
Val Loss: 0.5287, Val Accuracy: 81.43%
Epoch 7/10, Train Loss: 0.1398, Train Accuracy: 97.32%
Val Loss: 0.4154, Val Accuracy: 82.86%
Epoch 8/10, Train Loss: 0.0918, Train Accuracy: 98.57%
Val Loss: 0.3744, Val Accuracy: 85.71%
Epoch 9/10, Train Loss: 0.0622, Train Accuracy: 99.82%
Val Loss: 0.3620, Val Accuracy: 85.71%
Epoch 10/10, Train Loss: 0.0368, Train Accuracy: 100.00%
Val Loss: 0.3218, Val Accuracy: 87.86%
Best validation accuracy for cartoon: 87.86%
LoRA state keys: dict_keys(['base_model.model.blocks.0.attn.qkv.lora_A.weight', 'base_model.model.blocks.0.attn.qkv.lora_B.weight', 'base_model.model.blocks.1.attn.qkv.lora_A.weight', 'base_model.model.blocks.1.attn.qkv.lora_B.weight', 'base_model.model.blocks.2.attn.qkv.lora_A.weight', 'base_model.model.blocks.2.attn.qkv.lora_B.weight', 'base_model.model.blocks.3.attn.qkv.lora_A.weight', 'base_model.model.blocks.3.attn.qkv.lora_B.weight', 'base_model.model.blocks.4.attn.qkv.lora_A.weight', 'base_model.model.blocks.4.attn.qkv.lora_B.weight', 'base_model.model.blocks.5.attn.qkv.lora_A.weight', 'base_model.model.blocks.5.attn.qkv.lora_B.weight', 'base_model.model.blocks.6.attn.qkv.lora_A.weight', 'base_model.model.blocks.6.attn.qkv.lora_B.weight', 'base_model.model.blocks.7.attn.qkv.lora_A.weight', 'base_model.model.blocks.7.attn.qkv.lora_B.weight', 'base_model.model.blocks.8.attn.qkv.lora_A.weight', 'base_model.model.blocks.8.attn.qkv.lora_B.weight', 'base_model.model.blocks.9.attn.qkv.lora_A.weight', 'base_model.model.blocks.9.attn.qkv.lora_B.weight', 'base_model.model.blocks.10.attn.qkv.lora_A.weight', 'base_model.model.blocks.10.attn.qkv.lora_B.weight', 'base_model.model.blocks.11.attn.qkv.lora_A.weight', 'base_model.model.blocks.11.attn.qkv.lora_B.weight'])
cartoon adapter trained. Validation Accuracy: 87.86%

Training LoRA adapter for domain: photo

Training LoRA adapter for domain: photo
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Epoch 1/10, Train Loss: 2.0162, Train Accuracy: 18.04%
Val Loss: 1.7446, Val Accuracy: 33.57%
Epoch 2/10, Train Loss: 1.4804, Train Accuracy: 48.57%
Val Loss: 1.2309, Val Accuracy: 70.71%
Epoch 3/10, Train Loss: 0.8812, Train Accuracy: 85.89%
Val Loss: 0.6415, Val Accuracy: 90.71%
Epoch 4/10, Train Loss: 0.3619, Train Accuracy: 96.61%
Val Loss: 0.2440, Val Accuracy: 94.29%
Epoch 5/10, Train Loss: 0.1133, Train Accuracy: 98.75%
Val Loss: 0.1390, Val Accuracy: 96.43%
Epoch 6/10, Train Loss: 0.0382, Train Accuracy: 99.82%
Val Loss: 0.0986, Val Accuracy: 97.14%
Epoch 7/10, Train Loss: 0.0178, Train Accuracy: 100.00%
Val Loss: 0.0895, Val Accuracy: 97.86%
Epoch 8/10, Train Loss: 0.0101, Train Accuracy: 100.00%
Val Loss: 0.0853, Val Accuracy: 96.43%
Epoch 9/10, Train Loss: 0.0066, Train Accuracy: 100.00%
Val Loss: 0.0811, Val Accuracy: 97.14%
Epoch 10/10, Train Loss: 0.0049, Train Accuracy: 100.00%
Val Loss: 0.0800, Val Accuracy: 97.14%
Best validation accuracy for photo: 97.86%
LoRA state keys: dict_keys(['base_model.model.blocks.0.attn.qkv.lora_A.weight', 'base_model.model.blocks.0.attn.qkv.lora_B.weight', 'base_model.model.blocks.1.attn.qkv.lora_A.weight', 'base_model.model.blocks.1.attn.qkv.lora_B.weight', 'base_model.model.blocks.2.attn.qkv.lora_A.weight', 'base_model.model.blocks.2.attn.qkv.lora_B.weight', 'base_model.model.blocks.3.attn.qkv.lora_A.weight', 'base_model.model.blocks.3.attn.qkv.lora_B.weight', 'base_model.model.blocks.4.attn.qkv.lora_A.weight', 'base_model.model.blocks.4.attn.qkv.lora_B.weight', 'base_model.model.blocks.5.attn.qkv.lora_A.weight', 'base_model.model.blocks.5.attn.qkv.lora_B.weight', 'base_model.model.blocks.6.attn.qkv.lora_A.weight', 'base_model.model.blocks.6.attn.qkv.lora_B.weight', 'base_model.model.blocks.7.attn.qkv.lora_A.weight', 'base_model.model.blocks.7.attn.qkv.lora_B.weight', 'base_model.model.blocks.8.attn.qkv.lora_A.weight', 'base_model.model.blocks.8.attn.qkv.lora_B.weight', 'base_model.model.blocks.9.attn.qkv.lora_A.weight', 'base_model.model.blocks.9.attn.qkv.lora_B.weight', 'base_model.model.blocks.10.attn.qkv.lora_A.weight', 'base_model.model.blocks.10.attn.qkv.lora_B.weight', 'base_model.model.blocks.11.attn.qkv.lora_A.weight', 'base_model.model.blocks.11.attn.qkv.lora_B.weight'])
photo adapter trained. Validation Accuracy: 97.86%

Evaluating individual LoRA adapters on the test domain:
Created LoRA model: <class 'peft.peft_model.PeftModel'>
sketch adapter - Test Loss: 2.0543, Test Accuracy: 24.29%
Created LoRA model: <class 'peft.peft_model.PeftModel'>
cartoon adapter - Test Loss: 1.1831, Test Accuracy: 61.59%
Created LoRA model: <class 'peft.peft_model.PeftModel'>
photo adapter - Test Loss: 1.1841, Test Accuracy: 65.40%

Training coefficients for adapter merging
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Epoch 1, Loss: 1.0665, Accuracy: 68.57%
Coefficients: [0.30742487 0.32978022 0.362795  ]
Gradients: tensor([6.0315e-09, 6.8009e-09, 7.3331e-09], device='cuda:0')
Epoch 2, Loss: 1.0464, Accuracy: 68.57%
Coefficients: [0.30825162 0.33027977 0.3614686 ]
Gradients: tensor([ 2.5141e-09,  5.5464e-09, -4.8933e-09], device='cuda:0')
Epoch 3, Loss: 1.0041, Accuracy: 68.57%
Coefficients: [0.3090739 0.3301926 0.3607335]
Gradients: tensor([-6.6382e-09,  3.3068e-09,  3.3313e-09], device='cuda:0')
Epoch 4, Loss: 1.2244, Accuracy: 68.57%
Coefficients: [0.31028077 0.33031625 0.35940304]
Gradients: tensor([ 9.1245e-09, -7.9807e-09,  3.5313e-09], device='cuda:0')
Epoch 5, Loss: 0.7745, Accuracy: 68.57%
Coefficients: [0.31073773 0.33062354 0.35863873]
Gradients: tensor([ 1.2071e-09, -8.2122e-10, -3.8588e-10], device='cuda:0')
Epoch 6, Loss: 0.9355, Accuracy: 68.57%
Coefficients: [0.31108135 0.33085346 0.35806525]
Gradients: tensor([-7.9568e-09, -1.0963e-08, -9.1519e-09], device='cuda:0')
Epoch 7, Loss: 1.0337, Accuracy: 68.57%
Coefficients: [0.3115507  0.33095154 0.35749775]
Gradients: tensor([9.0554e-09, 3.4395e-09, 1.5740e-08], device='cuda:0')
Epoch 8, Loss: 0.9469, Accuracy: 68.57%
Coefficients: [0.31147712 0.33129108 0.3572318 ]
Gradients: tensor([ 3.2323e-11,  6.6827e-12, -3.9006e-11], device='cuda:0')
Epoch 9, Loss: 0.8512, Accuracy: 68.57%
Coefficients: [0.3113304  0.33151644 0.3571532 ]
Gradients: tensor([-5.9862e-10,  7.9828e-10,  4.5072e-10], device='cuda:0')
Epoch 10, Loss: 0.9140, Accuracy: 68.57%
Coefficients: [0.3113072 0.3317351 0.3569577]
Gradients: tensor([3.0668e-09, 1.1042e-09, 2.7919e-09], device='cuda:0')
Best coefficient accuracy: 68.57%
Final best coefficients: [0.30742487 0.32978022 0.362795  ]

Merged model with TIES - Test Loss: 1.1841, Test Accuracy: 65.40%

Debugging merged model predictions:
Batch 1:
  Labels: [5 3 3 2 4 3 5 3 4 0 6 2 2 6 6 6 1 4 1 2 1 3 5 4 4 6 0 2 4 0 1 0]
  Predictions: [5 3 3 2 0 3 5 3 4 0 3 2 2 0 0 0 1 2 0 0 3 3 5 0 4 6 0 2 4 0 0 0]
  Accuracy: 65.62%
Batch 2:
  Labels: [2 3 0 2 4 5 6 5 6 6 6 1 0 6 0 0 2 5 1 3 5 4 6 4 4 0 6 4 6 2 1 2]
  Predictions: [2 3 0 0 4 5 0 0 0 0 0 1 0 0 0 0 3 5 0 3 5 0 0 4 4 0 2 4 3 0 0 0]
  Accuracy: 50.00%
Batch 3:
  Labels: [3 1 1 3 1 6 3 6 2 3 6 6 2 5 4 3 1 2 2 6 4 2 4 3 1 4 4 6 1 0 0 2]
  Predictions: [3 1 1 3 1 0 3 0 2 3 0 0 2 5 4 3 1 0 2 6 0 2 4 3 0 4 4 0 0 0 0 0]
  Accuracy: 68.75%
Batch 4:
  Labels: [6 1 1 4 0 4 5 0 5 3 0 0 1 3 6 6 1 1 1 2 6 1 4 0 4 3 4 1 6 4 0 5]
  Predictions: [0 1 0 0 4 0 5 0 5 3 0 4 0 3 3 6 3 0 1 2 0 0 4 3 4 0 0 1 0 0 0 3]
  Accuracy: 43.75%
Batch 5:
  Labels: [1 1 5 0 6 1 6 5 0 3 2 6 3 2 6 6 5 0 5 5 4 4 2 1 4 5 2 6 1 5 3 2]
  Predictions: [0 0 5 0 6 3 0 5 0 3 2 0 3 0 0 3 5 0 5 5 0 4 2 1 3 5 2 0 4 5 3 3]
  Accuracy: 59.38%

Summary of All Runs:
Baseline Model Accuracy: 16.35% ± 0.00%
Merged Model Accuracy: 65.56% ± 0.22%
Average Coefficients:
  sketch: 0.3062 ± 0.0014
  cartoon: 0.3288 ± 0.0010
  photo: 0.3650 ± 0.0016
