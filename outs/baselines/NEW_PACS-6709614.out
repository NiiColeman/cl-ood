
--- Run 1/3 ---

Running LoRA with TIES experiment
Test domain: art_painting
Train domains: ['photo', 'cartoon', 'sketch']
Baseline Model - Test Loss: 2.2401, Test Accuracy: 16.35%

Training LoRA adapter for domain: photo

Training LoRA adapter for domain: photo
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Epoch 1/10, Train Loss: 1.9792, Train Accuracy: 20.54%
Val Loss: 1.7575, Val Accuracy: 27.86%
Epoch 2/10, Train Loss: 1.5024, Train Accuracy: 50.00%
Val Loss: 1.2327, Val Accuracy: 76.43%
Epoch 3/10, Train Loss: 0.9184, Train Accuracy: 85.18%
Val Loss: 0.6291, Val Accuracy: 93.57%
Epoch 4/10, Train Loss: 0.3917, Train Accuracy: 94.11%
Val Loss: 0.2295, Val Accuracy: 97.14%
Epoch 5/10, Train Loss: 0.1289, Train Accuracy: 98.57%
Val Loss: 0.0991, Val Accuracy: 97.86%
Epoch 6/10, Train Loss: 0.0429, Train Accuracy: 99.82%
Val Loss: 0.0699, Val Accuracy: 98.57%
Epoch 7/10, Train Loss: 0.0204, Train Accuracy: 100.00%
Val Loss: 0.0435, Val Accuracy: 99.29%
Epoch 8/10, Train Loss: 0.0110, Train Accuracy: 100.00%
Val Loss: 0.0514, Val Accuracy: 97.86%
Epoch 9/10, Train Loss: 0.0069, Train Accuracy: 100.00%
Val Loss: 0.0409, Val Accuracy: 98.57%
Epoch 10/10, Train Loss: 0.0048, Train Accuracy: 100.00%
Val Loss: 0.0386, Val Accuracy: 98.57%
Best validation accuracy for photo: 99.29%
LoRA state keys: dict_keys(['base_model.model.blocks.0.attn.qkv.lora_A.weight', 'base_model.model.blocks.0.attn.qkv.lora_B.weight', 'base_model.model.blocks.1.attn.qkv.lora_A.weight', 'base_model.model.blocks.1.attn.qkv.lora_B.weight', 'base_model.model.blocks.2.attn.qkv.lora_A.weight', 'base_model.model.blocks.2.attn.qkv.lora_B.weight', 'base_model.model.blocks.3.attn.qkv.lora_A.weight', 'base_model.model.blocks.3.attn.qkv.lora_B.weight', 'base_model.model.blocks.4.attn.qkv.lora_A.weight', 'base_model.model.blocks.4.attn.qkv.lora_B.weight', 'base_model.model.blocks.5.attn.qkv.lora_A.weight', 'base_model.model.blocks.5.attn.qkv.lora_B.weight', 'base_model.model.blocks.6.attn.qkv.lora_A.weight', 'base_model.model.blocks.6.attn.qkv.lora_B.weight', 'base_model.model.blocks.7.attn.qkv.lora_A.weight', 'base_model.model.blocks.7.attn.qkv.lora_B.weight', 'base_model.model.blocks.8.attn.qkv.lora_A.weight', 'base_model.model.blocks.8.attn.qkv.lora_B.weight', 'base_model.model.blocks.9.attn.qkv.lora_A.weight', 'base_model.model.blocks.9.attn.qkv.lora_B.weight', 'base_model.model.blocks.10.attn.qkv.lora_A.weight', 'base_model.model.blocks.10.attn.qkv.lora_B.weight', 'base_model.model.blocks.11.attn.qkv.lora_A.weight', 'base_model.model.blocks.11.attn.qkv.lora_B.weight'])
photo adapter trained. Validation Accuracy: 99.29%

Training LoRA adapter for domain: cartoon

Training LoRA adapter for domain: cartoon
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Epoch 1/10, Train Loss: 2.1491, Train Accuracy: 11.79%
Val Loss: 1.9029, Val Accuracy: 20.00%
Epoch 2/10, Train Loss: 1.7613, Train Accuracy: 29.46%
Val Loss: 1.5698, Val Accuracy: 38.57%
Epoch 3/10, Train Loss: 1.3392, Train Accuracy: 50.71%
Val Loss: 1.1221, Val Accuracy: 63.57%
Epoch 4/10, Train Loss: 0.8658, Train Accuracy: 73.21%
Val Loss: 0.7022, Val Accuracy: 77.86%
Epoch 5/10, Train Loss: 0.5175, Train Accuracy: 83.57%
Val Loss: 0.4901, Val Accuracy: 80.00%
Epoch 6/10, Train Loss: 0.3265, Train Accuracy: 90.54%
Val Loss: 0.3627, Val Accuracy: 87.86%
Epoch 7/10, Train Loss: 0.2124, Train Accuracy: 94.82%
Val Loss: 0.3223, Val Accuracy: 87.14%
Epoch 8/10, Train Loss: 0.1144, Train Accuracy: 98.75%
Val Loss: 0.2999, Val Accuracy: 87.86%
Epoch 9/10, Train Loss: 0.0725, Train Accuracy: 99.46%
Val Loss: 0.2659, Val Accuracy: 87.14%
Epoch 10/10, Train Loss: 0.0473, Train Accuracy: 100.00%
Val Loss: 0.2380, Val Accuracy: 90.71%
Best validation accuracy for cartoon: 90.71%
LoRA state keys: dict_keys(['base_model.model.blocks.0.attn.qkv.lora_A.weight', 'base_model.model.blocks.0.attn.qkv.lora_B.weight', 'base_model.model.blocks.1.attn.qkv.lora_A.weight', 'base_model.model.blocks.1.attn.qkv.lora_B.weight', 'base_model.model.blocks.2.attn.qkv.lora_A.weight', 'base_model.model.blocks.2.attn.qkv.lora_B.weight', 'base_model.model.blocks.3.attn.qkv.lora_A.weight', 'base_model.model.blocks.3.attn.qkv.lora_B.weight', 'base_model.model.blocks.4.attn.qkv.lora_A.weight', 'base_model.model.blocks.4.attn.qkv.lora_B.weight', 'base_model.model.blocks.5.attn.qkv.lora_A.weight', 'base_model.model.blocks.5.attn.qkv.lora_B.weight', 'base_model.model.blocks.6.attn.qkv.lora_A.weight', 'base_model.model.blocks.6.attn.qkv.lora_B.weight', 'base_model.model.blocks.7.attn.qkv.lora_A.weight', 'base_model.model.blocks.7.attn.qkv.lora_B.weight', 'base_model.model.blocks.8.attn.qkv.lora_A.weight', 'base_model.model.blocks.8.attn.qkv.lora_B.weight', 'base_model.model.blocks.9.attn.qkv.lora_A.weight', 'base_model.model.blocks.9.attn.qkv.lora_B.weight', 'base_model.model.blocks.10.attn.qkv.lora_A.weight', 'base_model.model.blocks.10.attn.qkv.lora_B.weight', 'base_model.model.blocks.11.attn.qkv.lora_A.weight', 'base_model.model.blocks.11.attn.qkv.lora_B.weight'])
cartoon adapter trained. Validation Accuracy: 90.71%

Training LoRA adapter for domain: sketch

Training LoRA adapter for domain: sketch
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Epoch 1/10, Train Loss: 1.7798, Train Accuracy: 31.99%
Val Loss: 1.5864, Val Accuracy: 40.44%
Epoch 2/10, Train Loss: 1.3753, Train Accuracy: 52.57%
Val Loss: 1.2826, Val Accuracy: 49.26%
Epoch 3/10, Train Loss: 1.0583, Train Accuracy: 65.81%
Val Loss: 0.9819, Val Accuracy: 63.97%
Epoch 4/10, Train Loss: 0.8045, Train Accuracy: 72.79%
Val Loss: 0.7902, Val Accuracy: 66.18%
Epoch 5/10, Train Loss: 0.6254, Train Accuracy: 79.60%
Val Loss: 0.6915, Val Accuracy: 72.79%
Epoch 6/10, Train Loss: 0.5182, Train Accuracy: 84.74%
Val Loss: 0.6330, Val Accuracy: 75.00%
Epoch 7/10, Train Loss: 0.4446, Train Accuracy: 84.74%
Val Loss: 0.6588, Val Accuracy: 74.26%
Epoch 8/10, Train Loss: 0.3653, Train Accuracy: 88.05%
Val Loss: 0.5978, Val Accuracy: 75.74%
Epoch 9/10, Train Loss: 0.3088, Train Accuracy: 90.62%
Val Loss: 0.5576, Val Accuracy: 77.94%
Epoch 10/10, Train Loss: 0.2595, Train Accuracy: 93.20%
Val Loss: 0.5007, Val Accuracy: 77.21%
Best validation accuracy for sketch: 77.94%
LoRA state keys: dict_keys(['base_model.model.blocks.0.attn.qkv.lora_A.weight', 'base_model.model.blocks.0.attn.qkv.lora_B.weight', 'base_model.model.blocks.1.attn.qkv.lora_A.weight', 'base_model.model.blocks.1.attn.qkv.lora_B.weight', 'base_model.model.blocks.2.attn.qkv.lora_A.weight', 'base_model.model.blocks.2.attn.qkv.lora_B.weight', 'base_model.model.blocks.3.attn.qkv.lora_A.weight', 'base_model.model.blocks.3.attn.qkv.lora_B.weight', 'base_model.model.blocks.4.attn.qkv.lora_A.weight', 'base_model.model.blocks.4.attn.qkv.lora_B.weight', 'base_model.model.blocks.5.attn.qkv.lora_A.weight', 'base_model.model.blocks.5.attn.qkv.lora_B.weight', 'base_model.model.blocks.6.attn.qkv.lora_A.weight', 'base_model.model.blocks.6.attn.qkv.lora_B.weight', 'base_model.model.blocks.7.attn.qkv.lora_A.weight', 'base_model.model.blocks.7.attn.qkv.lora_B.weight', 'base_model.model.blocks.8.attn.qkv.lora_A.weight', 'base_model.model.blocks.8.attn.qkv.lora_B.weight', 'base_model.model.blocks.9.attn.qkv.lora_A.weight', 'base_model.model.blocks.9.attn.qkv.lora_B.weight', 'base_model.model.blocks.10.attn.qkv.lora_A.weight', 'base_model.model.blocks.10.attn.qkv.lora_B.weight', 'base_model.model.blocks.11.attn.qkv.lora_A.weight', 'base_model.model.blocks.11.attn.qkv.lora_B.weight'])
sketch adapter trained. Validation Accuracy: 77.94%

Evaluating individual LoRA adapters on the test domain:
Created LoRA model: <class 'peft.peft_model.PeftModel'>
photo adapter - Test Loss: 1.1791, Test Accuracy: 65.40%
Created LoRA model: <class 'peft.peft_model.PeftModel'>
cartoon adapter - Test Loss: 1.1457, Test Accuracy: 64.13%
Created LoRA model: <class 'peft.peft_model.PeftModel'>
sketch adapter - Test Loss: 2.0472, Test Accuracy: 25.40%

Training coefficients for adapter merging
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Epoch 1, Loss: 2.1188, Accuracy: 28.57%
Coefficients: [0.30523443 0.3275162  0.3672493 ]
Gradients: tensor([-1.3203e-09,  3.4847e-09,  3.8344e-09], device='cuda:0')
Epoch 2, Loss: 1.9991, Accuracy: 28.57%
Coefficients: [0.30457896 0.32721385 0.36820713]
Gradients: tensor([ 1.4689e-10,  2.7152e-10, -3.5690e-10], device='cuda:0')
Epoch 3, Loss: 2.3320, Accuracy: 28.57%
Coefficients: [0.30412015 0.327043   0.36883685]
Gradients: tensor([-8.1355e-09, -4.9538e-10,  2.5831e-08], device='cuda:0')
Epoch 4, Loss: 1.9465, Accuracy: 28.57%
Coefficients: [0.3045718  0.32666394 0.36876425]
Gradients: tensor([-2.4919e-09,  1.0590e-10,  2.7507e-09], device='cuda:0')
Epoch 5, Loss: 2.1287, Accuracy: 28.57%
Coefficients: [0.3050494 0.3266745 0.3682761]
Gradients: tensor([-4.4896e-09, -5.3238e-09, -3.3114e-09], device='cuda:0')
Epoch 6, Loss: 2.2110, Accuracy: 28.57%
Coefficients: [0.30531952 0.3269306  0.36774993]
Gradients: tensor([-1.2766e-09,  6.7027e-09, -5.4520e-09], device='cuda:0')
Epoch 7, Loss: 2.1733, Accuracy: 28.57%
Coefficients: [0.30556712 0.3275289  0.36690402]
Gradients: tensor([-1.0264e-08, -1.2275e-08, -3.4929e-09], device='cuda:0')
Epoch 8, Loss: 2.2043, Accuracy: 28.57%
Coefficients: [0.30584243 0.32805192 0.3661056 ]
Gradients: tensor([3.6482e-08, 5.3587e-08, 5.4465e-08], device='cuda:0')
Epoch 9, Loss: 2.2251, Accuracy: 28.57%
Coefficients: [0.30659685 0.32818437 0.36521876]
Gradients: tensor([-1.3436e-08,  1.0573e-09,  1.3016e-08], device='cuda:0')
Epoch 10, Loss: 2.1286, Accuracy: 28.57%
Coefficients: [0.30801743 0.32846138 0.36352116]
Gradients: tensor([ 2.0406e-09, -6.1745e-09,  4.1340e-09], device='cuda:0')
Best coefficient accuracy: 28.57%
Final best coefficients: [0.30523443 0.3275162  0.3672493 ]

Merged model with TIES - Test Loss: 2.0472, Test Accuracy: 25.40%

Debugging merged model predictions:
Batch 1:
  Labels: [5 3 3 2 4 3 5 3 4 0 6 2 2 6 6 6 1 4 1 2 1 3 5 4 4 6 0 2 4 0 1 0]
  Predictions: [2 4 4 2 1 6 2 4 4 6 4 2 0 6 3 3 4 2 0 0 4 1 2 0 4 3 3 2 4 0 0 0]
  Accuracy: 28.12%
Batch 2:
  Labels: [2 3 0 2 4 5 6 5 6 6 6 1 0 6 0 0 2 5 1 3 5 4 6 4 4 0 6 4 6 2 1 2]
  Predictions: [2 2 6 0 6 5 2 0 3 4 6 4 2 4 0 6 2 2 0 3 4 6 0 2 4 6 4 4 6 0 0 6]
  Accuracy: 28.12%
Batch 3:
  Labels: [3 1 1 3 1 6 3 6 2 3 6 6 2 5 4 3 1 2 2 6 4 2 4 3 1 4 4 6 1 0 0 2]
  Predictions: [3 6 2 3 6 6 2 5 0 2 6 3 2 2 0 1 0 0 2 6 4 2 3 2 3 2 4 1 0 3 4 6]
  Accuracy: 31.25%
Batch 4:
  Labels: [6 1 1 4 0 4 5 0 5 3 0 0 1 3 6 6 1 1 1 2 6 1 4 0 4 3 4 1 6 4 0 5]
  Predictions: [0 2 6 2 4 0 4 6 2 6 2 2 0 3 2 5 0 6 0 2 0 6 2 3 4 6 6 2 2 6 6 0]
  Accuracy: 9.38%
Batch 5:
  Labels: [1 1 5 0 6 1 6 5 0 3 2 6 3 2 6 6 5 0 5 5 4 4 2 1 4 5 2 6 1 5 3 2]
  Predictions: [0 0 4 0 0 6 2 4 4 6 2 3 6 2 4 6 2 0 2 2 3 6 0 0 2 2 2 2 6 2 3 6]
  Accuracy: 21.88%

--- Run 2/3 ---

Running LoRA with TIES experiment
Test domain: art_painting
Train domains: ['photo', 'cartoon', 'sketch']
Baseline Model - Test Loss: 2.2401, Test Accuracy: 16.35%

Training LoRA adapter for domain: photo

Training LoRA adapter for domain: photo
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Epoch 1/10, Train Loss: 1.9792, Train Accuracy: 20.54%
Val Loss: 1.7575, Val Accuracy: 27.86%
Epoch 2/10, Train Loss: 1.5025, Train Accuracy: 50.00%
Val Loss: 1.2335, Val Accuracy: 75.71%
Epoch 3/10, Train Loss: 0.9162, Train Accuracy: 84.64%
Val Loss: 0.6341, Val Accuracy: 94.29%
Epoch 4/10, Train Loss: 0.3946, Train Accuracy: 93.93%
Val Loss: 0.2281, Val Accuracy: 97.14%
Epoch 5/10, Train Loss: 0.1322, Train Accuracy: 98.57%
Val Loss: 0.1003, Val Accuracy: 98.57%
Epoch 6/10, Train Loss: 0.0465, Train Accuracy: 99.82%
Val Loss: 0.0707, Val Accuracy: 98.57%
Epoch 7/10, Train Loss: 0.0220, Train Accuracy: 100.00%
Val Loss: 0.0473, Val Accuracy: 99.29%
Epoch 8/10, Train Loss: 0.0121, Train Accuracy: 100.00%
Val Loss: 0.0538, Val Accuracy: 98.57%
Epoch 9/10, Train Loss: 0.0076, Train Accuracy: 100.00%
Val Loss: 0.0431, Val Accuracy: 97.86%
Epoch 10/10, Train Loss: 0.0053, Train Accuracy: 100.00%
Val Loss: 0.0404, Val Accuracy: 98.57%
Best validation accuracy for photo: 99.29%
LoRA state keys: dict_keys(['base_model.model.blocks.0.attn.qkv.lora_A.weight', 'base_model.model.blocks.0.attn.qkv.lora_B.weight', 'base_model.model.blocks.1.attn.qkv.lora_A.weight', 'base_model.model.blocks.1.attn.qkv.lora_B.weight', 'base_model.model.blocks.2.attn.qkv.lora_A.weight', 'base_model.model.blocks.2.attn.qkv.lora_B.weight', 'base_model.model.blocks.3.attn.qkv.lora_A.weight', 'base_model.model.blocks.3.attn.qkv.lora_B.weight', 'base_model.model.blocks.4.attn.qkv.lora_A.weight', 'base_model.model.blocks.4.attn.qkv.lora_B.weight', 'base_model.model.blocks.5.attn.qkv.lora_A.weight', 'base_model.model.blocks.5.attn.qkv.lora_B.weight', 'base_model.model.blocks.6.attn.qkv.lora_A.weight', 'base_model.model.blocks.6.attn.qkv.lora_B.weight', 'base_model.model.blocks.7.attn.qkv.lora_A.weight', 'base_model.model.blocks.7.attn.qkv.lora_B.weight', 'base_model.model.blocks.8.attn.qkv.lora_A.weight', 'base_model.model.blocks.8.attn.qkv.lora_B.weight', 'base_model.model.blocks.9.attn.qkv.lora_A.weight', 'base_model.model.blocks.9.attn.qkv.lora_B.weight', 'base_model.model.blocks.10.attn.qkv.lora_A.weight', 'base_model.model.blocks.10.attn.qkv.lora_B.weight', 'base_model.model.blocks.11.attn.qkv.lora_A.weight', 'base_model.model.blocks.11.attn.qkv.lora_B.weight'])
photo adapter trained. Validation Accuracy: 99.29%

Training LoRA adapter for domain: cartoon

Training LoRA adapter for domain: cartoon
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Epoch 1/10, Train Loss: 2.1491, Train Accuracy: 11.79%
Val Loss: 1.9029, Val Accuracy: 20.00%
Epoch 2/10, Train Loss: 1.7613, Train Accuracy: 29.46%
Val Loss: 1.5698, Val Accuracy: 38.57%
Epoch 3/10, Train Loss: 1.3390, Train Accuracy: 50.71%
Val Loss: 1.1209, Val Accuracy: 64.29%
Epoch 4/10, Train Loss: 0.8672, Train Accuracy: 73.21%
Val Loss: 0.7068, Val Accuracy: 77.14%
Epoch 5/10, Train Loss: 0.5195, Train Accuracy: 83.04%
Val Loss: 0.4963, Val Accuracy: 80.00%
Epoch 6/10, Train Loss: 0.3280, Train Accuracy: 90.36%
Val Loss: 0.3636, Val Accuracy: 87.14%
Epoch 7/10, Train Loss: 0.2130, Train Accuracy: 94.64%
Val Loss: 0.3277, Val Accuracy: 86.43%
Epoch 8/10, Train Loss: 0.1145, Train Accuracy: 98.75%
Val Loss: 0.3025, Val Accuracy: 88.57%
Epoch 9/10, Train Loss: 0.0731, Train Accuracy: 99.46%
Val Loss: 0.2695, Val Accuracy: 87.14%
Epoch 10/10, Train Loss: 0.0480, Train Accuracy: 100.00%
Val Loss: 0.2400, Val Accuracy: 90.00%
Best validation accuracy for cartoon: 90.00%
LoRA state keys: dict_keys(['base_model.model.blocks.0.attn.qkv.lora_A.weight', 'base_model.model.blocks.0.attn.qkv.lora_B.weight', 'base_model.model.blocks.1.attn.qkv.lora_A.weight', 'base_model.model.blocks.1.attn.qkv.lora_B.weight', 'base_model.model.blocks.2.attn.qkv.lora_A.weight', 'base_model.model.blocks.2.attn.qkv.lora_B.weight', 'base_model.model.blocks.3.attn.qkv.lora_A.weight', 'base_model.model.blocks.3.attn.qkv.lora_B.weight', 'base_model.model.blocks.4.attn.qkv.lora_A.weight', 'base_model.model.blocks.4.attn.qkv.lora_B.weight', 'base_model.model.blocks.5.attn.qkv.lora_A.weight', 'base_model.model.blocks.5.attn.qkv.lora_B.weight', 'base_model.model.blocks.6.attn.qkv.lora_A.weight', 'base_model.model.blocks.6.attn.qkv.lora_B.weight', 'base_model.model.blocks.7.attn.qkv.lora_A.weight', 'base_model.model.blocks.7.attn.qkv.lora_B.weight', 'base_model.model.blocks.8.attn.qkv.lora_A.weight', 'base_model.model.blocks.8.attn.qkv.lora_B.weight', 'base_model.model.blocks.9.attn.qkv.lora_A.weight', 'base_model.model.blocks.9.attn.qkv.lora_B.weight', 'base_model.model.blocks.10.attn.qkv.lora_A.weight', 'base_model.model.blocks.10.attn.qkv.lora_B.weight', 'base_model.model.blocks.11.attn.qkv.lora_A.weight', 'base_model.model.blocks.11.attn.qkv.lora_B.weight'])
cartoon adapter trained. Validation Accuracy: 90.00%

Training LoRA adapter for domain: sketch

Training LoRA adapter for domain: sketch
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Epoch 1/10, Train Loss: 1.7798, Train Accuracy: 31.99%
Val Loss: 1.5864, Val Accuracy: 40.44%
Epoch 2/10, Train Loss: 1.3753, Train Accuracy: 52.57%
Val Loss: 1.2826, Val Accuracy: 49.26%
Epoch 3/10, Train Loss: 1.0583, Train Accuracy: 65.81%
Val Loss: 0.9819, Val Accuracy: 63.97%
Epoch 4/10, Train Loss: 0.8045, Train Accuracy: 72.79%
Val Loss: 0.7902, Val Accuracy: 66.18%
Epoch 5/10, Train Loss: 0.6254, Train Accuracy: 79.60%
Val Loss: 0.6915, Val Accuracy: 72.79%
Epoch 6/10, Train Loss: 0.5182, Train Accuracy: 84.74%
Val Loss: 0.6330, Val Accuracy: 75.00%
Epoch 7/10, Train Loss: 0.4446, Train Accuracy: 84.74%
Val Loss: 0.6588, Val Accuracy: 74.26%
Epoch 8/10, Train Loss: 0.3653, Train Accuracy: 88.05%
Val Loss: 0.5978, Val Accuracy: 75.74%
Epoch 9/10, Train Loss: 0.3088, Train Accuracy: 90.62%
Val Loss: 0.5576, Val Accuracy: 77.94%
Epoch 10/10, Train Loss: 0.2595, Train Accuracy: 93.20%
Val Loss: 0.5007, Val Accuracy: 77.21%
Best validation accuracy for sketch: 77.94%
LoRA state keys: dict_keys(['base_model.model.blocks.0.attn.qkv.lora_A.weight', 'base_model.model.blocks.0.attn.qkv.lora_B.weight', 'base_model.model.blocks.1.attn.qkv.lora_A.weight', 'base_model.model.blocks.1.attn.qkv.lora_B.weight', 'base_model.model.blocks.2.attn.qkv.lora_A.weight', 'base_model.model.blocks.2.attn.qkv.lora_B.weight', 'base_model.model.blocks.3.attn.qkv.lora_A.weight', 'base_model.model.blocks.3.attn.qkv.lora_B.weight', 'base_model.model.blocks.4.attn.qkv.lora_A.weight', 'base_model.model.blocks.4.attn.qkv.lora_B.weight', 'base_model.model.blocks.5.attn.qkv.lora_A.weight', 'base_model.model.blocks.5.attn.qkv.lora_B.weight', 'base_model.model.blocks.6.attn.qkv.lora_A.weight', 'base_model.model.blocks.6.attn.qkv.lora_B.weight', 'base_model.model.blocks.7.attn.qkv.lora_A.weight', 'base_model.model.blocks.7.attn.qkv.lora_B.weight', 'base_model.model.blocks.8.attn.qkv.lora_A.weight', 'base_model.model.blocks.8.attn.qkv.lora_B.weight', 'base_model.model.blocks.9.attn.qkv.lora_A.weight', 'base_model.model.blocks.9.attn.qkv.lora_B.weight', 'base_model.model.blocks.10.attn.qkv.lora_A.weight', 'base_model.model.blocks.10.attn.qkv.lora_B.weight', 'base_model.model.blocks.11.attn.qkv.lora_A.weight', 'base_model.model.blocks.11.attn.qkv.lora_B.weight'])
sketch adapter trained. Validation Accuracy: 77.94%

Evaluating individual LoRA adapters on the test domain:
Created LoRA model: <class 'peft.peft_model.PeftModel'>
photo adapter - Test Loss: 1.1829, Test Accuracy: 63.97%
Created LoRA model: <class 'peft.peft_model.PeftModel'>
cartoon adapter - Test Loss: 1.1660, Test Accuracy: 63.49%
Created LoRA model: <class 'peft.peft_model.PeftModel'>
sketch adapter - Test Loss: 2.0472, Test Accuracy: 25.40%

Training coefficients for adapter merging
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Epoch 1, Loss: 2.1188, Accuracy: 28.57%
Coefficients: [0.30659145 0.32830712 0.3651014 ]
Gradients: tensor([-4.4508e-09,  7.0983e-10, -1.1160e-08], device='cuda:0')
Epoch 2, Loss: 1.9991, Accuracy: 28.57%
Coefficients: [0.3068221  0.32770702 0.3654709 ]
Gradients: tensor([-3.1094e-10, -2.5840e-10, -3.6198e-10], device='cuda:0')
Epoch 3, Loss: 2.3320, Accuracy: 28.57%
Coefficients: [0.30678955 0.32762575 0.36558464]
Gradients: tensor([ 1.0171e-08, -5.3045e-09,  7.7357e-09], device='cuda:0')
Epoch 4, Loss: 1.9465, Accuracy: 28.57%
Coefficients: [0.306594   0.32815248 0.3652535 ]
Gradients: tensor([-3.4536e-09,  1.0281e-09,  2.0608e-09], device='cuda:0')
Epoch 5, Loss: 2.1287, Accuracy: 28.57%
Coefficients: [0.3068499  0.32804826 0.36510184]
Gradients: tensor([ 4.8570e-09, -2.4230e-09, -1.5458e-09], device='cuda:0')
Epoch 6, Loss: 2.2110, Accuracy: 28.57%
Coefficients: [0.30676365 0.32798266 0.36525372]
Gradients: tensor([ 5.5717e-09, -1.4751e-09, -4.0449e-09], device='cuda:0')
Epoch 7, Loss: 2.1733, Accuracy: 28.57%
Coefficients: [0.3062411  0.32748577 0.36627316]
Gradients: tensor([2.6382e-08, 1.7498e-08, 8.1858e-09], device='cuda:0')
Epoch 8, Loss: 2.2043, Accuracy: 28.57%
Coefficients: [0.3057111  0.32708785 0.36720106]
Gradients: tensor([ 2.3844e-09, -3.8307e-09,  1.4463e-09], device='cuda:0')
Epoch 9, Loss: 2.2251, Accuracy: 28.57%
Coefficients: [0.30498078 0.3269554  0.36806384]
Gradients: tensor([ 1.2885e-08, -3.2263e-09, -9.6585e-09], device='cuda:0')
Epoch 10, Loss: 2.1286, Accuracy: 28.57%
Coefficients: [0.30406857 0.3268786  0.36905283]
Gradients: tensor([ 7.0200e-09, -2.1449e-09, -4.8751e-09], device='cuda:0')
Best coefficient accuracy: 28.57%
Final best coefficients: [0.30659145 0.32830712 0.3651014 ]

Merged model with TIES - Test Loss: 2.0472, Test Accuracy: 25.40%

Debugging merged model predictions:
Batch 1:
  Labels: [5 3 3 2 4 3 5 3 4 0 6 2 2 6 6 6 1 4 1 2 1 3 5 4 4 6 0 2 4 0 1 0]
  Predictions: [2 4 4 2 1 6 2 4 4 6 4 2 0 6 3 3 4 2 0 0 4 1 2 0 4 3 3 2 4 0 0 0]
  Accuracy: 28.12%
Batch 2:
  Labels: [2 3 0 2 4 5 6 5 6 6 6 1 0 6 0 0 2 5 1 3 5 4 6 4 4 0 6 4 6 2 1 2]
  Predictions: [2 2 6 0 6 5 2 0 3 4 6 4 2 4 0 6 2 2 0 3 4 6 0 2 4 6 4 4 6 0 0 6]
  Accuracy: 28.12%
Batch 3:
  Labels: [3 1 1 3 1 6 3 6 2 3 6 6 2 5 4 3 1 2 2 6 4 2 4 3 1 4 4 6 1 0 0 2]
  Predictions: [3 6 2 3 6 6 2 5 0 2 6 3 2 2 0 1 0 0 2 6 4 2 3 2 3 2 4 1 0 3 4 6]
  Accuracy: 31.25%
Batch 4:
  Labels: [6 1 1 4 0 4 5 0 5 3 0 0 1 3 6 6 1 1 1 2 6 1 4 0 4 3 4 1 6 4 0 5]
  Predictions: [0 2 6 2 4 0 4 6 2 6 2 2 0 3 2 5 0 6 0 2 0 6 2 3 4 6 6 2 2 6 6 0]
  Accuracy: 9.38%
Batch 5:
  Labels: [1 1 5 0 6 1 6 5 0 3 2 6 3 2 6 6 5 0 5 5 4 4 2 1 4 5 2 6 1 5 3 2]
  Predictions: [0 0 4 0 0 6 2 4 4 6 2 3 6 2 4 6 2 0 2 2 3 6 0 0 2 2 2 2 6 2 3 6]
  Accuracy: 21.88%

--- Run 3/3 ---

Running LoRA with TIES experiment
Test domain: art_painting
Train domains: ['photo', 'cartoon', 'sketch']
Baseline Model - Test Loss: 2.2401, Test Accuracy: 16.35%

Training LoRA adapter for domain: photo

Training LoRA adapter for domain: photo
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Epoch 1/10, Train Loss: 1.9792, Train Accuracy: 20.54%
Val Loss: 1.7575, Val Accuracy: 27.86%
Epoch 2/10, Train Loss: 1.5024, Train Accuracy: 50.00%
Val Loss: 1.2325, Val Accuracy: 76.43%
Epoch 3/10, Train Loss: 0.9188, Train Accuracy: 85.36%
Val Loss: 0.6277, Val Accuracy: 94.29%
Epoch 4/10, Train Loss: 0.3922, Train Accuracy: 94.46%
Val Loss: 0.2283, Val Accuracy: 97.14%
Epoch 5/10, Train Loss: 0.1279, Train Accuracy: 98.75%
Val Loss: 0.1009, Val Accuracy: 97.86%
Epoch 6/10, Train Loss: 0.0434, Train Accuracy: 99.82%
Val Loss: 0.0711, Val Accuracy: 98.57%
Epoch 7/10, Train Loss: 0.0213, Train Accuracy: 99.82%
Val Loss: 0.0412, Val Accuracy: 99.29%
Epoch 8/10, Train Loss: 0.0113, Train Accuracy: 100.00%
Val Loss: 0.0500, Val Accuracy: 97.86%
Epoch 9/10, Train Loss: 0.0070, Train Accuracy: 100.00%
Val Loss: 0.0391, Val Accuracy: 98.57%
Epoch 10/10, Train Loss: 0.0049, Train Accuracy: 100.00%
Val Loss: 0.0372, Val Accuracy: 98.57%
Best validation accuracy for photo: 99.29%
LoRA state keys: dict_keys(['base_model.model.blocks.0.attn.qkv.lora_A.weight', 'base_model.model.blocks.0.attn.qkv.lora_B.weight', 'base_model.model.blocks.1.attn.qkv.lora_A.weight', 'base_model.model.blocks.1.attn.qkv.lora_B.weight', 'base_model.model.blocks.2.attn.qkv.lora_A.weight', 'base_model.model.blocks.2.attn.qkv.lora_B.weight', 'base_model.model.blocks.3.attn.qkv.lora_A.weight', 'base_model.model.blocks.3.attn.qkv.lora_B.weight', 'base_model.model.blocks.4.attn.qkv.lora_A.weight', 'base_model.model.blocks.4.attn.qkv.lora_B.weight', 'base_model.model.blocks.5.attn.qkv.lora_A.weight', 'base_model.model.blocks.5.attn.qkv.lora_B.weight', 'base_model.model.blocks.6.attn.qkv.lora_A.weight', 'base_model.model.blocks.6.attn.qkv.lora_B.weight', 'base_model.model.blocks.7.attn.qkv.lora_A.weight', 'base_model.model.blocks.7.attn.qkv.lora_B.weight', 'base_model.model.blocks.8.attn.qkv.lora_A.weight', 'base_model.model.blocks.8.attn.qkv.lora_B.weight', 'base_model.model.blocks.9.attn.qkv.lora_A.weight', 'base_model.model.blocks.9.attn.qkv.lora_B.weight', 'base_model.model.blocks.10.attn.qkv.lora_A.weight', 'base_model.model.blocks.10.attn.qkv.lora_B.weight', 'base_model.model.blocks.11.attn.qkv.lora_A.weight', 'base_model.model.blocks.11.attn.qkv.lora_B.weight'])
photo adapter trained. Validation Accuracy: 99.29%

Training LoRA adapter for domain: cartoon

Training LoRA adapter for domain: cartoon
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Epoch 1/10, Train Loss: 2.1491, Train Accuracy: 11.79%
Val Loss: 1.9029, Val Accuracy: 20.00%
Epoch 2/10, Train Loss: 1.7613, Train Accuracy: 29.46%
Val Loss: 1.5697, Val Accuracy: 38.57%
Epoch 3/10, Train Loss: 1.3396, Train Accuracy: 50.89%
Val Loss: 1.1240, Val Accuracy: 63.57%
Epoch 4/10, Train Loss: 0.8672, Train Accuracy: 73.57%
Val Loss: 0.7108, Val Accuracy: 77.86%
Epoch 5/10, Train Loss: 0.5181, Train Accuracy: 83.57%
Val Loss: 0.4934, Val Accuracy: 80.71%
Epoch 6/10, Train Loss: 0.3249, Train Accuracy: 90.54%
Val Loss: 0.3638, Val Accuracy: 87.86%
Epoch 7/10, Train Loss: 0.2102, Train Accuracy: 94.82%
Val Loss: 0.3288, Val Accuracy: 86.43%
Epoch 8/10, Train Loss: 0.1137, Train Accuracy: 98.93%
Val Loss: 0.2980, Val Accuracy: 89.29%
Epoch 9/10, Train Loss: 0.0720, Train Accuracy: 99.46%
Val Loss: 0.2656, Val Accuracy: 87.86%
Epoch 10/10, Train Loss: 0.0473, Train Accuracy: 100.00%
Val Loss: 0.2399, Val Accuracy: 90.71%
Best validation accuracy for cartoon: 90.71%
LoRA state keys: dict_keys(['base_model.model.blocks.0.attn.qkv.lora_A.weight', 'base_model.model.blocks.0.attn.qkv.lora_B.weight', 'base_model.model.blocks.1.attn.qkv.lora_A.weight', 'base_model.model.blocks.1.attn.qkv.lora_B.weight', 'base_model.model.blocks.2.attn.qkv.lora_A.weight', 'base_model.model.blocks.2.attn.qkv.lora_B.weight', 'base_model.model.blocks.3.attn.qkv.lora_A.weight', 'base_model.model.blocks.3.attn.qkv.lora_B.weight', 'base_model.model.blocks.4.attn.qkv.lora_A.weight', 'base_model.model.blocks.4.attn.qkv.lora_B.weight', 'base_model.model.blocks.5.attn.qkv.lora_A.weight', 'base_model.model.blocks.5.attn.qkv.lora_B.weight', 'base_model.model.blocks.6.attn.qkv.lora_A.weight', 'base_model.model.blocks.6.attn.qkv.lora_B.weight', 'base_model.model.blocks.7.attn.qkv.lora_A.weight', 'base_model.model.blocks.7.attn.qkv.lora_B.weight', 'base_model.model.blocks.8.attn.qkv.lora_A.weight', 'base_model.model.blocks.8.attn.qkv.lora_B.weight', 'base_model.model.blocks.9.attn.qkv.lora_A.weight', 'base_model.model.blocks.9.attn.qkv.lora_B.weight', 'base_model.model.blocks.10.attn.qkv.lora_A.weight', 'base_model.model.blocks.10.attn.qkv.lora_B.weight', 'base_model.model.blocks.11.attn.qkv.lora_A.weight', 'base_model.model.blocks.11.attn.qkv.lora_B.weight'])
cartoon adapter trained. Validation Accuracy: 90.71%

Training LoRA adapter for domain: sketch

Training LoRA adapter for domain: sketch
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Epoch 1/10, Train Loss: 1.7798, Train Accuracy: 31.99%
Val Loss: 1.5864, Val Accuracy: 40.44%
Epoch 2/10, Train Loss: 1.3753, Train Accuracy: 52.57%
Val Loss: 1.2826, Val Accuracy: 49.26%
Epoch 3/10, Train Loss: 1.0583, Train Accuracy: 65.81%
Val Loss: 0.9819, Val Accuracy: 63.97%
Epoch 4/10, Train Loss: 0.8045, Train Accuracy: 72.79%
Val Loss: 0.7902, Val Accuracy: 66.18%
Epoch 5/10, Train Loss: 0.6254, Train Accuracy: 79.60%
Val Loss: 0.6915, Val Accuracy: 72.79%
Epoch 6/10, Train Loss: 0.5182, Train Accuracy: 84.74%
Val Loss: 0.6330, Val Accuracy: 75.00%
Epoch 7/10, Train Loss: 0.4446, Train Accuracy: 84.74%
Val Loss: 0.6588, Val Accuracy: 74.26%
Epoch 8/10, Train Loss: 0.3653, Train Accuracy: 88.05%
Val Loss: 0.5978, Val Accuracy: 75.74%
Epoch 9/10, Train Loss: 0.3088, Train Accuracy: 90.62%
Val Loss: 0.5576, Val Accuracy: 77.94%
Epoch 10/10, Train Loss: 0.2595, Train Accuracy: 93.20%
Val Loss: 0.5007, Val Accuracy: 77.21%
Best validation accuracy for sketch: 77.94%
LoRA state keys: dict_keys(['base_model.model.blocks.0.attn.qkv.lora_A.weight', 'base_model.model.blocks.0.attn.qkv.lora_B.weight', 'base_model.model.blocks.1.attn.qkv.lora_A.weight', 'base_model.model.blocks.1.attn.qkv.lora_B.weight', 'base_model.model.blocks.2.attn.qkv.lora_A.weight', 'base_model.model.blocks.2.attn.qkv.lora_B.weight', 'base_model.model.blocks.3.attn.qkv.lora_A.weight', 'base_model.model.blocks.3.attn.qkv.lora_B.weight', 'base_model.model.blocks.4.attn.qkv.lora_A.weight', 'base_model.model.blocks.4.attn.qkv.lora_B.weight', 'base_model.model.blocks.5.attn.qkv.lora_A.weight', 'base_model.model.blocks.5.attn.qkv.lora_B.weight', 'base_model.model.blocks.6.attn.qkv.lora_A.weight', 'base_model.model.blocks.6.attn.qkv.lora_B.weight', 'base_model.model.blocks.7.attn.qkv.lora_A.weight', 'base_model.model.blocks.7.attn.qkv.lora_B.weight', 'base_model.model.blocks.8.attn.qkv.lora_A.weight', 'base_model.model.blocks.8.attn.qkv.lora_B.weight', 'base_model.model.blocks.9.attn.qkv.lora_A.weight', 'base_model.model.blocks.9.attn.qkv.lora_B.weight', 'base_model.model.blocks.10.attn.qkv.lora_A.weight', 'base_model.model.blocks.10.attn.qkv.lora_B.weight', 'base_model.model.blocks.11.attn.qkv.lora_A.weight', 'base_model.model.blocks.11.attn.qkv.lora_B.weight'])
sketch adapter trained. Validation Accuracy: 77.94%

Evaluating individual LoRA adapters on the test domain:
Created LoRA model: <class 'peft.peft_model.PeftModel'>
photo adapter - Test Loss: 1.1848, Test Accuracy: 65.08%
Created LoRA model: <class 'peft.peft_model.PeftModel'>
cartoon adapter - Test Loss: 1.1566, Test Accuracy: 63.65%
Created LoRA model: <class 'peft.peft_model.PeftModel'>
sketch adapter - Test Loss: 2.0472, Test Accuracy: 25.40%

Training coefficients for adapter merging
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Created LoRA model: <class 'peft.peft_model.PeftModel'>
Epoch 1, Loss: 2.1188, Accuracy: 28.57%
Coefficients: [0.30274165 0.32927576 0.3679826 ]
Gradients: tensor([-1.0778e-08, -2.2667e-08, -8.3550e-09], device='cuda:0')
Epoch 2, Loss: 1.9991, Accuracy: 28.57%
Coefficients: [0.30271888 0.32998735 0.36729378]
Gradients: tensor([-2.2235e-10,  2.6697e-10, -4.4614e-11], device='cuda:0')
Epoch 3, Loss: 2.3320, Accuracy: 28.57%
Coefficients: [0.30262825 0.33087632 0.3664954 ]
Gradients: tensor([4.9544e-08, 4.1328e-08, 4.0940e-08], device='cuda:0')
Epoch 4, Loss: 1.9465, Accuracy: 28.57%
Coefficients: [0.30271608 0.331731   0.36555296]
Gradients: tensor([-3.9641e-09, -1.8920e-09, -8.6804e-09], device='cuda:0')
Epoch 5, Loss: 2.1287, Accuracy: 28.57%
Coefficients: [0.3029408  0.33208963 0.36496958]
Gradients: tensor([1.2926e-08, 2.1315e-08, 2.6252e-08], device='cuda:0')
Epoch 6, Loss: 2.2110, Accuracy: 28.57%
Coefficients: [0.30316785 0.33242932 0.3644028 ]
Gradients: tensor([ 1.1754e-08, -6.0326e-09, -5.6960e-09], device='cuda:0')
Epoch 7, Loss: 2.1733, Accuracy: 28.57%
Coefficients: [0.30326477 0.33255497 0.36418024]
Gradients: tensor([2.6784e-08, 2.1790e-08, 7.2607e-09], device='cuda:0')
Epoch 8, Loss: 2.2043, Accuracy: 28.57%
Coefficients: [0.30330104 0.3326916  0.36400735]
Gradients: tensor([4.7380e-08, 4.4168e-08, 3.6103e-08], device='cuda:0')
Epoch 9, Loss: 2.2251, Accuracy: 28.57%
Coefficients: [0.3033168  0.33290598 0.3637772 ]
Gradients: tensor([-5.4837e-09,  1.7637e-09,  4.3570e-09], device='cuda:0')
Epoch 10, Loss: 2.1286, Accuracy: 28.57%
Coefficients: [0.30368635 0.33330438 0.36300924]
Gradients: tensor([-4.6691e-09, -3.6736e-09, -6.5585e-09], device='cuda:0')
Best coefficient accuracy: 28.57%
Final best coefficients: [0.30274165 0.32927576 0.3679826 ]

Merged model with TIES - Test Loss: 2.0472, Test Accuracy: 25.40%

Debugging merged model predictions:
Batch 1:
  Labels: [5 3 3 2 4 3 5 3 4 0 6 2 2 6 6 6 1 4 1 2 1 3 5 4 4 6 0 2 4 0 1 0]
  Predictions: [2 4 4 2 1 6 2 4 4 6 4 2 0 6 3 3 4 2 0 0 4 1 2 0 4 3 3 2 4 0 0 0]
  Accuracy: 28.12%
Batch 2:
  Labels: [2 3 0 2 4 5 6 5 6 6 6 1 0 6 0 0 2 5 1 3 5 4 6 4 4 0 6 4 6 2 1 2]
  Predictions: [2 2 6 0 6 5 2 0 3 4 6 4 2 4 0 6 2 2 0 3 4 6 0 2 4 6 4 4 6 0 0 6]
  Accuracy: 28.12%
Batch 3:
  Labels: [3 1 1 3 1 6 3 6 2 3 6 6 2 5 4 3 1 2 2 6 4 2 4 3 1 4 4 6 1 0 0 2]
  Predictions: [3 6 2 3 6 6 2 5 0 2 6 3 2 2 0 1 0 0 2 6 4 2 3 2 3 2 4 1 0 3 4 6]
  Accuracy: 31.25%
Batch 4:
  Labels: [6 1 1 4 0 4 5 0 5 3 0 0 1 3 6 6 1 1 1 2 6 1 4 0 4 3 4 1 6 4 0 5]
  Predictions: [0 2 6 2 4 0 4 6 2 6 2 2 0 3 2 5 0 6 0 2 0 6 2 3 4 6 6 2 2 6 6 0]
  Accuracy: 9.38%
Batch 5:
  Labels: [1 1 5 0 6 1 6 5 0 3 2 6 3 2 6 6 5 0 5 5 4 4 2 1 4 5 2 6 1 5 3 2]
  Predictions: [0 0 4 0 0 6 2 4 4 6 2 3 6 2 4 6 2 0 2 2 3 6 0 0 2 2 2 2 6 2 3 6]
  Accuracy: 21.88%

Summary of All Runs:
Baseline Model Accuracy: 16.35% ± 0.00%
Merged Model Accuracy: 25.40% ± 0.00%
Average Coefficients:
  photo: 0.3049 ± 0.0016
  cartoon: 0.3284 ± 0.0007
  sketch: 0.3668 ± 0.0012
