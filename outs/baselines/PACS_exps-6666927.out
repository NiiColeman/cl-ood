
==================================================
Running experiments for dataset: PACS
==================================================
Dataset config for PACS:
{'dataset_path': '/leonardo_scratch/fast/IscrC_FoundCL/cl/lora-CL/ratatouille/ood/datasets/PACS', 'max_samples_per_class': None, 'base_model': 'vit_base_patch16_224', 'batch_size': 32, 'num_epochs': 10, 'learning_rate': 0.001, 'lora_r': 16, 'lora_alpha': 16, 'lora_dropout': 0.05, 'coefficient_learning_rate': 1, 'coefficient_epochs': 10, 'seed': 42}
Type of dataset_config: <class 'dict'>
Contents of dataset_config:
{'dataset_path': '/leonardo_scratch/fast/IscrC_FoundCL/cl/lora-CL/ratatouille/ood/datasets/PACS', 'max_samples_per_class': None, 'base_model': 'vit_base_patch16_224', 'batch_size': 32, 'num_epochs': 10, 'learning_rate': 0.001, 'lora_r': 16, 'lora_alpha': 16, 'lora_dropout': 0.05, 'coefficient_learning_rate': 1, 'coefficient_epochs': 10, 'seed': 42}

Run 1/10
Preparing data...
Domains: ['sketch', 'cartoon', 'art_painting', 'photo']
Selected test domain: cartoon
Training domains: ['sketch', 'art_painting', 'photo']
Test domain: cartoon
Performing naive fine-tuning on test domain
Epoch 1, Average Loss: 2.5904
Epoch 2, Average Loss: 1.7580
Epoch 3, Average Loss: 1.5575
Epoch 4, Average Loss: 1.4417
Epoch 5, Average Loss: 1.3883
Epoch 6, Average Loss: 1.2840
Epoch 7, Average Loss: 1.2119
Epoch 8, Average Loss: 1.1503
Epoch 9, Average Loss: 1.0972
Epoch 10, Average Loss: 1.1593
Accuracy: 48.0375
Training domains: ['sketch', 'art_painting', 'photo']

Training expert models...

Training model for domain: sketch
Training model for domain: sketch
Epoch 1, Average Loss: 0.5310
Epoch 2, Average Loss: 0.1480
Epoch 3, Average Loss: 0.0967
Epoch 4, Average Loss: 0.0696
Epoch 5, Average Loss: 0.0516
Epoch 6, Average Loss: 0.0650
Epoch 7, Average Loss: 0.0737
Epoch 8, Average Loss: 0.0416
Epoch 9, Average Loss: 0.0525
Epoch 10, Average Loss: 0.0323
Merged model device: cuda:0
Accuracy: 65.0171
Accuracy of sketch model on test domain: 65.0171

Training model for domain: art_painting
Training model for domain: art_painting
Epoch 1, Average Loss: 0.3878
Epoch 2, Average Loss: 0.0387
Epoch 3, Average Loss: 0.0148
Epoch 4, Average Loss: 0.0129
Epoch 5, Average Loss: 0.0160
Epoch 6, Average Loss: 0.0124
Epoch 7, Average Loss: 0.1069
Epoch 8, Average Loss: 0.0442
Epoch 9, Average Loss: 0.0143
Epoch 10, Average Loss: 0.0085
Merged model device: cuda:0
Accuracy: 68.3447
Accuracy of art_painting model on test domain: 68.3447

Training model for domain: photo
Training model for domain: photo
Epoch 1, Average Loss: 0.1712
Epoch 2, Average Loss: 0.0118
Epoch 3, Average Loss: 0.0168
Epoch 4, Average Loss: 0.0014
Epoch 5, Average Loss: 0.0158
Epoch 6, Average Loss: 0.0042
Epoch 7, Average Loss: 0.0014
Epoch 8, Average Loss: 0.0000
Epoch 9, Average Loss: 0.0000
Epoch 10, Average Loss: 0.0000
Merged model device: cuda:0
Accuracy: 38.9078
Accuracy of photo model on test domain: 38.9078

Training coefficients...
Training coefficients for weight averaging
Device: cuda
Coefficients device: cuda:0
Expert model sketch device: cuda:0
Expert model art_painting device: cuda:0
Expert model photo device: cuda:0
Domain sketch - Input device: cuda:0, Model device: cuda:0
Domain art_painting - Input device: cuda:0, Model device: cuda:0
Domain photo - Input device: cuda:0, Model device: cuda:0
Coefficient Epoch 1, Average Loss: 1.5007
Coefficient Epoch 2, Average Loss: 1.0190
Coefficient Epoch 3, Average Loss: 0.8679
Coefficient Epoch 4, Average Loss: 0.7814
Coefficient Epoch 5, Average Loss: 0.8374
Coefficient Epoch 6, Average Loss: 0.9128
Coefficient Epoch 7, Average Loss: 1.0480
Coefficient Epoch 8, Average Loss: 0.9122
Coefficient Epoch 9, Average Loss: 1.2126
Coefficient Epoch 10, Average Loss: 0.9412
Final device check:
Expert model sketch device: cuda:0
Expert model art_painting device: cuda:0
Expert model photo device: cuda:0
Coefficient training complete.
Learned coefficients: [0.3940250873565674, 0.28179970383644104, 0.32417523860931396]

Creating weight-averaged model...
Creating weight-averaged model
Weight-averaged model created.

Evaluating final model...
Accuracy: 71.8430
Final model accuracy on test domain: 71.8430

Run 2/10
Preparing data...
Domains: ['sketch', 'cartoon', 'art_painting', 'photo']
Selected test domain: art_painting
Training domains: ['sketch', 'cartoon', 'photo']
Test domain: art_painting
Performing naive fine-tuning on test domain
Epoch 1, Average Loss: 2.9058
Epoch 2, Average Loss: 2.0552
Epoch 3, Average Loss: 2.0206
Epoch 4, Average Loss: 1.9935
Epoch 5, Average Loss: 1.9320
Epoch 6, Average Loss: 1.8796
Epoch 7, Average Loss: 1.9220
Epoch 8, Average Loss: 1.8637
Epoch 9, Average Loss: 1.8801
Epoch 10, Average Loss: 1.8486
Accuracy: 27.0508
Training domains: ['sketch', 'cartoon', 'photo']

Training expert models...

Training model for domain: sketch
Training model for domain: sketch
Epoch 1, Average Loss: 0.5808
