
==================================================
Running experiments for dataset: PACS
==================================================
Dataset config for PACS:
{'dataset_path': '/leonardo_scratch/fast/IscrC_FoundCL/cl/lora-CL/ratatouille/ood/datasets/PACS', 'max_samples_per_class': None, 'base_model': 'vit_base_patch16_224', 'batch_size': 32, 'num_epochs': 10, 'learning_rate': 0.0001, 'lora_r': 16, 'lora_alpha': 16, 'lora_dropout': 0.05, 'coefficient_learning_rate': 1, 'coefficient_epochs': 10, 'seed': 42}
Type of dataset_config: <class 'dict'>
Contents of dataset_config:
{'dataset_path': '/leonardo_scratch/fast/IscrC_FoundCL/cl/lora-CL/ratatouille/ood/datasets/PACS', 'max_samples_per_class': None, 'base_model': 'vit_base_patch16_224', 'batch_size': 32, 'num_epochs': 10, 'learning_rate': 0.0001, 'lora_r': 16, 'lora_alpha': 16, 'lora_dropout': 0.05, 'coefficient_learning_rate': 1, 'coefficient_epochs': 10, 'seed': 42}

Run 1/10
Preparing data...
Domains: ['sketch', 'photo', 'cartoon', 'art_painting']
Selected test domain: sketch
Training domains: ['photo', 'cartoon', 'art_painting']
Test domain: sketch
Performing naive fine-tuning on test domain
Epoch 1, Average Loss: 1.8521
Epoch 2, Average Loss: 1.5156
Epoch 3, Average Loss: 1.1535
Epoch 4, Average Loss: 0.8469
Epoch 5, Average Loss: 0.5703
Epoch 6, Average Loss: 0.3076
Epoch 7, Average Loss: 0.1786
Epoch 8, Average Loss: 0.1228
Epoch 9, Average Loss: 0.0641
Epoch 10, Average Loss: 0.1056
Accuracy: 70.6870
Training domains: ['photo', 'cartoon', 'art_painting']

Training expert models...

Training model for domain: photo
Training model for domain: photo
Epoch 1, Average Loss: 0.9107
Epoch 2, Average Loss: 0.0557
Epoch 3, Average Loss: 0.0069
Epoch 4, Average Loss: 0.0026
Epoch 5, Average Loss: 0.0013
Epoch 6, Average Loss: 0.0008
Epoch 7, Average Loss: 0.0006
Epoch 8, Average Loss: 0.0004
Epoch 9, Average Loss: 0.0003
Epoch 10, Average Loss: 0.0003
Merged model device: cuda:0
Accuracy: 30.4326
Accuracy of photo model on test domain: 30.4326

Training model for domain: cartoon
Training model for domain: cartoon
Epoch 1, Average Loss: 1.1227
Epoch 2, Average Loss: 0.2747
Epoch 3, Average Loss: 0.1087
Epoch 4, Average Loss: 0.0360
Epoch 5, Average Loss: 0.0140
Epoch 6, Average Loss: 0.0066
Epoch 7, Average Loss: 0.0039
Epoch 8, Average Loss: 0.0027
Epoch 9, Average Loss: 0.0019
Epoch 10, Average Loss: 0.0015
Merged model device: cuda:0
Accuracy: 33.9949
Accuracy of cartoon model on test domain: 33.9949

Training model for domain: art_painting
Training model for domain: art_painting
Epoch 1, Average Loss: 1.2193
Epoch 2, Average Loss: 0.1726
Epoch 3, Average Loss: 0.0358
Epoch 4, Average Loss: 0.0079
Epoch 5, Average Loss: 0.0029
Epoch 6, Average Loss: 0.0016
Epoch 7, Average Loss: 0.0011
Epoch 8, Average Loss: 0.0008
Epoch 9, Average Loss: 0.0006
Epoch 10, Average Loss: 0.0005
Merged model device: cuda:0
Accuracy: 54.6565
Accuracy of art_painting model on test domain: 54.6565

Training coefficients...
Training coefficients for weight averaging
Device: cuda
Coefficients device: cuda:0
Expert model photo device: cuda:0
Expert model cartoon device: cuda:0
Expert model art_painting device: cuda:0
Domain photo - Input device: cuda:0, Model device: cuda:0
Domain cartoon - Input device: cuda:0, Model device: cuda:0
Domain art_painting - Input device: cuda:0, Model device: cuda:0
Coefficient Epoch 1, Average Loss: 1.3481
Coefficient Epoch 2, Average Loss: 1.2851
Coefficient Epoch 3, Average Loss: 1.2541
Coefficient Epoch 4, Average Loss: 1.2368
Coefficient Epoch 5, Average Loss: 1.2676
Coefficient Epoch 6, Average Loss: 1.2062
Coefficient Epoch 7, Average Loss: 1.2212
Coefficient Epoch 8, Average Loss: 1.2584
Coefficient Epoch 9, Average Loss: 1.2167
Coefficient Epoch 10, Average Loss: 1.1948
Final device check:
Expert model photo device: cuda:0
Expert model cartoon device: cuda:0
Expert model art_painting device: cuda:0
Coefficient training complete.
Learned coefficients: [0.29796698689460754, 0.30613642930984497, 0.3958966135978699]

Creating weight-averaged model...
Creating weight-averaged model
Weight-averaged model created.

Evaluating final model...
Accuracy: 54.5038
Final model accuracy on test domain: 54.5038

Run 2/10
Preparing data...
Domains: ['sketch', 'photo', 'cartoon', 'art_painting']
Selected test domain: photo
Training domains: ['sketch', 'cartoon', 'art_painting']
Test domain: photo
Performing naive fine-tuning on test domain
Epoch 1, Average Loss: 0.2973
Epoch 2, Average Loss: 0.1209
Epoch 3, Average Loss: 0.0220
Epoch 4, Average Loss: 0.0191
Epoch 5, Average Loss: 0.0036
Epoch 6, Average Loss: 0.0008
Epoch 7, Average Loss: 0.0004
Epoch 8, Average Loss: 0.0003
Epoch 9, Average Loss: 0.0001
Epoch 10, Average Loss: 0.0000
Accuracy: 98.5629
Training domains: ['sketch', 'cartoon', 'art_painting']

Training expert models...

Training model for domain: sketch
Training model for domain: sketch
Epoch 1, Average Loss: 1.1131
Epoch 2, Average Loss: 0.5035
Epoch 3, Average Loss: 0.2961
Epoch 4, Average Loss: 0.1743
Epoch 5, Average Loss: 0.0927
Epoch 6, Average Loss: 0.0414
Epoch 7, Average Loss: 0.0159
Epoch 8, Average Loss: 0.0063
Epoch 9, Average Loss: 0.0033
Epoch 10, Average Loss: 0.0022
Merged model device: cuda:0
Accuracy: 36.7665
Accuracy of sketch model on test domain: 36.7665

Training model for domain: cartoon
Training model for domain: cartoon
Epoch 1, Average Loss: 1.3519
Epoch 2, Average Loss: 0.2962
Epoch 3, Average Loss: 0.1158
Epoch 4, Average Loss: 0.0461
Epoch 5, Average Loss: 0.0176
Epoch 6, Average Loss: 0.0058
Epoch 7, Average Loss: 0.0033
Epoch 8, Average Loss: 0.0021
Epoch 9, Average Loss: 0.0015
Epoch 10, Average Loss: 0.0011
Merged model device: cuda:0
Accuracy: 91.2575
Accuracy of cartoon model on test domain: 91.2575

Training model for domain: art_painting
Training model for domain: art_painting
Epoch 1, Average Loss: 1.2286
Epoch 2, Average Loss: 0.2009
Epoch 3, Average Loss: 0.0506
Epoch 4, Average Loss: 0.0168
Epoch 5, Average Loss: 0.0056
Epoch 6, Average Loss: 0.0023
Epoch 7, Average Loss: 0.0015
Epoch 8, Average Loss: 0.0011
Epoch 9, Average Loss: 0.0008
Epoch 10, Average Loss: 0.0006
Merged model device: cuda:0
Accuracy: 99.6407
Accuracy of art_painting model on test domain: 99.6407

Training coefficients...
Training coefficients for weight averaging
Device: cuda
Coefficients device: cuda:0
Expert model sketch device: cuda:0
Expert model cartoon device: cuda:0
Expert model art_painting device: cuda:0
Domain sketch - Input device: cuda:0, Model device: cuda:0
Domain cartoon - Input device: cuda:0, Model device: cuda:0
Domain art_painting - Input device: cuda:0, Model device: cuda:0
Coefficient Epoch 1, Average Loss: 0.1039
Coefficient Epoch 2, Average Loss: 0.0603
Coefficient Epoch 3, Average Loss: 0.0661
Coefficient Epoch 4, Average Loss: 0.0668
Coefficient Epoch 5, Average Loss: 0.0472
Coefficient Epoch 6, Average Loss: 0.0663
Coefficient Epoch 7, Average Loss: 0.0709
Coefficient Epoch 8, Average Loss: 0.0606
Coefficient Epoch 9, Average Loss: 0.0516
Coefficient Epoch 10, Average Loss: 0.0864
Final device check:
Expert model sketch device: cuda:0
Expert model cartoon device: cuda:0
Expert model art_painting device: cuda:0
Coefficient training complete.
Learned coefficients: [0.24994578957557678, 0.21644772589206696, 0.5336064696311951]

Creating weight-averaged model...
Creating weight-averaged model
Weight-averaged model created.

Evaluating final model...
Accuracy: 97.7246
Final model accuracy on test domain: 97.7246

Run 3/10
Preparing data...
Domains: ['sketch', 'photo', 'cartoon', 'art_painting']
Selected test domain: photo
Training domains: ['sketch', 'cartoon', 'art_painting']
Test domain: photo
Performing naive fine-tuning on test domain
Epoch 1, Average Loss: 0.2807
Epoch 2, Average Loss: 0.0630
Epoch 3, Average Loss: 0.0549
Epoch 4, Average Loss: 0.0542
Epoch 5, Average Loss: 0.0097
Epoch 6, Average Loss: 0.0091
Epoch 7, Average Loss: 0.0395
Epoch 8, Average Loss: 0.0110
Epoch 9, Average Loss: 0.0027
Epoch 10, Average Loss: 0.0282
Accuracy: 94.4910
Training domains: ['sketch', 'cartoon', 'art_painting']

Training expert models...

Training model for domain: sketch
Training model for domain: sketch
Epoch 1, Average Loss: 1.0118
Epoch 2, Average Loss: 0.4421
Epoch 3, Average Loss: 0.2662
Epoch 4, Average Loss: 0.1414
Epoch 5, Average Loss: 0.0640
Epoch 6, Average Loss: 0.0227
Epoch 7, Average Loss: 0.0105
Epoch 8, Average Loss: 0.0036
Epoch 9, Average Loss: 0.0020
Epoch 10, Average Loss: 0.0014
Merged model device: cuda:0
Accuracy: 54.7305
Accuracy of sketch model on test domain: 54.7305

Training model for domain: cartoon
Training model for domain: cartoon
Epoch 1, Average Loss: 1.2645
Epoch 2, Average Loss: 0.2550
Epoch 3, Average Loss: 0.0914
Epoch 4, Average Loss: 0.0343
Epoch 5, Average Loss: 0.0109
Epoch 6, Average Loss: 0.0058
Epoch 7, Average Loss: 0.0033
Epoch 8, Average Loss: 0.0023
Epoch 9, Average Loss: 0.0017
Epoch 10, Average Loss: 0.0012
Merged model device: cuda:0
Accuracy: 93.4132
Accuracy of cartoon model on test domain: 93.4132

Training model for domain: art_painting
Training model for domain: art_painting
Epoch 1, Average Loss: 1.2568
Epoch 2, Average Loss: 0.1688
Epoch 3, Average Loss: 0.0459
Epoch 4, Average Loss: 0.0117
Epoch 5, Average Loss: 0.0038
Epoch 6, Average Loss: 0.0021
Epoch 7, Average Loss: 0.0014
Epoch 8, Average Loss: 0.0010
